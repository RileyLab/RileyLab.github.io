<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Riley Lab – TC Hood Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TUI Calendar v1 + deps (fixed versions, correct order) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tui-code-snippet@1.5.2/dist/tui-code-snippet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --TC1:#2563eb; --TC2:#16a34a; --TC3:#f59e0b;
      --TC1b:#60a5fa; --TC1c:#93c5fd; 
      --TC2b:#22c55e; --TC2c:#86efac;
      --TC3b:#fbbf24; --TC3c:#fde68a;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:12px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .title{margin-left:auto;font-weight:600}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 16px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;box-shadow:0 0 0 2px #fff,inset 0 0 0 1px #0001}
    #calendar{height:72vh;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .legend{margin-top:8px;color:var(--muted)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(520px,92vw);background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .modal h3{margin:0 0 12px 0;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row{display:flex;gap:10px}
    label{font-size:12px;color:#374151;margin-bottom:4px;display:block}
    input[type="text"], input[type="date"], input[type="time"], select{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff
    }
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .btn.danger{background:#b91c1c;color:#fff;border-color:#b91c1c}
    .btn.muted{background:#f3f4f6;border-color:#e5e7eb}
    #spinner{position:fixed;right:16px;bottom:16px;padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:10px;box-shadow:var(--shadow);display:none}

    .room-tabs {
      display:flex; gap:10px; align-items:center; margin:8px 0 16px;
    }
    
    .tab {
      position:relative;
      appearance:none; border:none; cursor:pointer;
      padding:10px 16px; border-radius:12px;
      background:#fff; color:var(--text);
      box-shadow:0 2px 6px rgba(0,0,0,.06), inset 0 0 0 1px var(--border);
      font-weight:600; letter-spacing:.2px;
      transition:transform .05s ease, box-shadow .15s ease, background .15s ease;
    }
    
    .tab:hover { box-shadow:0 3px 10px rgba(0,0,0,.09), inset 0 0 0 1px #d8dbe1; }
    .tab:active { transform:translateY(1px); }
    
    .tab.is-active {
      background:var(--card);
      box-shadow:0 6px 16px rgba(0,0,0,.12), inset 0 0 0 2px #a9b4ff;
    }
    
    .tab .dot { width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:8px; }
    .tab .dot.tc1 { background: var(--TC1); }
    .tab .dot.tc2 { background: var(--TC2); }
    .tab .dot.tc3 { background: var(--TC3); }
    .tab .dot.all {
      background: linear-gradient(90deg, var(--TC1) 0 33%, var(--TC2) 33% 66%, var(--TC3) 66% 100%);
    }
    
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button class="btn" id="prev">‹</button>
    <button class="btn" id="today">Today</button>
    <button class="btn" id="next">›</button>
    <button class="btn" id="week">Week</button>
    <button class="btn" id="day">Day</button>
    <div class="title" id="range"></div>
  </div>

  <!-- Room tabs -->
  <div class="room-tabs" id="roomTabs" role="tablist" aria-label="Rooms">
    <button class="tab is-active" role="tab" aria-selected="true" data-room="ALL">
      <span class="dot all"></span> All
    </button>
    <button class="tab" role="tab" aria-selected="false" data-room="TC1">
      <span class="dot tc1"></span> TC1
    </button>
    <button class="tab" role="tab" aria-selected="false" data-room="TC2">
      <span class="dot tc2"></span> TC2
    </button>
    <button class="tab" role="tab" aria-selected="false" data-room="TC3">
      <span class="dot tc3"></span> TC3
    </button>
  </div>

  <div id="calendar"></div>
  <div class="legend">Drag to select a time range; release to open the form. Click an event to edit. Delete is in the edit dialog.</div>
</div>

<!-- Spinner -->
<div id="spinner">Saving…</div>

<!-- Modal (Create/Edit) -->
<div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true">
  <div class="modal" id="modalCard">
    <h3 id="modalTitle">New Booking</h3>
    <div class="grid">
      <div>
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Your name">
      </div>
      <div>
        <label for="date">Date</label>
        <input id="date" type="date">
      </div>
      <div>
        <label for="start">Start time</label>
        <input id="start" type="time" step="900">
      </div>
      <div>
        <label for="end">End time</label>
        <input id="end" type="time" step="900">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label for="room">Room</label>
        <select id="room">
          <option value="TC1">TC1</option>
          <option value="TC2">TC2</option>
          <option value="TC3">TC3</option>
        </select>
      </div>
      <div style="flex:1">
        <label for="hood">Hood</label>
        <select id="hood">
          <option value="1">Hood 1</option>
          <option value="2">Hood 2</option>
          <option value="3">Hood 3</option>
        </select>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn muted" id="cancelBtn">Cancel</button>
      <button class="btn danger" id="deleteBtn" style="display:none">Delete</button>
      <button class="btn primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
  /********* UPDATE THIS LINE WITH YOUR CURRENT /exec URL *********/
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwzkzB0tuX-1jtCrF0byVzWGhKkH_4Sko6RYImOQ48LSnZwuy7SCVgkC01_t_Ja2otS/exec';
  /****************************************************************/

  // Calendar definitions (colors)
  const calDefs = [
    ['TC1','1','var(--TC1)'], ['TC1','2','var(--TC1b)'], ['TC1','3','var(--TC1c)'],
    ['TC2','1','var(--TC2)'], ['TC2','2','var(--TC2b)'], ['TC2','3','var(--TC2c)'],
    ['TC3','1','var(--TC3)'], ['TC3','2','var(--TC3b)'], ['TC3','3','var(--TC3c)'],
  ].map(([room,hood,color]) => ({
    id: `${room}-${hood}`,
    name: `${room}/Hood ${hood}`,
    color: '#fff',
    bgColor: getComputedStyle(document.documentElement).getPropertyValue(color).trim()
  }));

  // Build the calendar with no built-in popups (we’ll use our own)
  const calendar = new tui.Calendar(document.getElementById('calendar'), {
    defaultView: 'week',
    taskView: false,
    scheduleView: ['time'],
    useCreationPopup: false,
    useDetailPopup: false,
    isReadOnly: false,
    week: { hourStart: 8, hourEnd: 20, workweek: true, narrowWeekend: true, startDayOfWeek: 1 },
    calendars: calDefs
  });

  /* ---------- Helpers ---------- */
  const hasGetSchedules = !!calendar.getSchedules; // v1
  const Cal = {
    all(){ return hasGetSchedules ? calendar.getSchedules() : []; },
    add(arr){ return calendar.createSchedules(arr); },
    update(id, calId, changes){ return calendar.updateSchedule(id, calId, changes); },
    remove(id, calId){ return calendar.deleteSchedule(id, calId); },
    clear(){ return calendar.clear(); },
    visible(calId, vis){ return calendar.setCalendarVisibility(calId, vis); }
  };

  function setRangeTitle(){
    const s = calendar.getDateRangeStart().toDate();
    const e = calendar.getDateRangeEnd().toDate();
    document.getElementById('range').textContent =
      `${s.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${e.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
  }
  setRangeTitle();

  const modalBg = document.getElementById('modalBg');
  const modalTitle = document.getElementById('modalTitle');
  const nameEl = document.getElementById('name');
  const dateEl = document.getElementById('date');
  const startEl = document.getElementById('start');
  const endEl = document.getElementById('end');
  const roomEl = document.getElementById('room');
  const hoodEl = document.getElementById('hood');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const spinner = document.getElementById('spinner');

  let BUSY = false;
  let editing = null; // {id, calendarId, start, end, raw:{name,room,hood}}

  function showSpin(v){ spinner.style.display = v ? 'block' : 'none'; }
  function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)}) }

  function openModal(title, preset){
    modalTitle.textContent = title;
    modalBg.style.display = 'flex';
    // preset fields
    nameEl.value  = preset?.name || '';
    dateEl.value  = preset?.date || '';
    startEl.value = preset?.start || '';
    endEl.value   = preset?.end || '';
    roomEl.value  = preset?.room || 'TC1';
    hoodEl.value  = preset?.hood || '1';
    deleteBtn.style.display = preset?.mode === 'edit' ? 'inline-block' : 'none';
    setTimeout(()=>nameEl.focus(), 0);
  }
  function closeModal(){ modalBg.style.display = 'none'; }

  function toLocalDateInputValue(d){
    const t = new Date(d); t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
    return t.toISOString().slice(0,10);
  }
  function toLocalTimeInputValue(d){
    const t = new Date(d); t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
    return t.toISOString().slice(11,16);
  }
  function buildDate(dateStr, timeStr){
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);
    return new Date(y, m-1, d, hh, mm, 0, 0);
  }

  function titleFor(name, room, hood){ return `${name || 'Booking'} — ${room}/Hood ${hood}`; }

  function overlaps(aStart,aEnd,bStart,bEnd){ return aStart < bEnd && bStart < aEnd; }
  function hasConflict(calendarId, start, end, ignoreId){
    return Cal.all().some(s=>{
      if (s.calendarId !== calendarId) return false;
      if (ignoreId && s.id === ignoreId) return false;
      return overlaps(s.start.toDate(), s.end.toDate(), start, end);
    });
  }

  async function postSimple(payload){
    showSpin(true);
    try{
      const res = await fetch(ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain' },
        credentials:'omit',
        body: JSON.stringify(payload)
      });
      // We trust backend; even if it returns ok:false, reload will correct UI
      try { return await res.json(); } catch { return {}; }
    } finally { showSpin(false); }
  }

  async function loadFromBackend(){
    try{
      const s = calendar.getDateRangeStart().toDate().toISOString();
      const e = calendar.getDateRangeEnd().toDate().toISOString();
      const res = await fetch(`${ENDPOINT}?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}`);
      const json = await res.json();
      if (!Array.isArray(json)) { console.warn('Backend returned', json); return; }
      Cal.clear();
      Cal.add(json.map(x=>({
        id:x.id, calendarId:x.calendarId, title:x.title,
        category:'time', start:new Date(x.start), end:new Date(x.end),
        isReadOnly:false
      })));
    }catch(err){ console.error('loadFromBackend failed:', err); }
  }

  /* ---------- Toolbar / Filters ---------- */
  document.getElementById('prev').onclick  = ()=>{ calendar.prev();  setRangeTitle(); loadFromBackend(); };
  document.getElementById('today').onclick = ()=>{ calendar.today(); setRangeTitle(); loadFromBackend(); };
  document.getElementById('next').onclick  = ()=>{ calendar.next();  setRangeTitle(); loadFromBackend(); };
  document.getElementById('week').onclick  = ()=>{ calendar.changeView('week',true); setRangeTitle(); loadFromBackend(); };
  document.getElementById('day').onclick   = ()=>{ calendar.changeView('day', true); setRangeTitle(); loadFromBackend(); };

  // helper to toggle visibility for whole rooms
  function setRoomVisibility(room){  // room = 'ALL' | 'TC1' | 'TC2' | 'TC3'
    const rooms = ['TC1','TC2','TC3'];
    const showAll = (room === 'ALL');

    rooms.forEach(r => {
      const visible = showAll || (r === room);
      // each room has 3 hoods: r-1, r-2, r-3
      ['1','2','3'].forEach(h => {
        if (calendar.setCalendarVisibility) {
          calendar.setCalendarVisibility(`${r}-${h}`, visible);
        } else if (calendar.toggleSchedules) {
          calendar.toggleSchedules(`${r}-${h}`, visible);
        }
      });
    });
  }

  // initial state: "All" visible
  setRoomVisibility('ALL');

  // click/keyboard handlers for tabs
  document.getElementById('roomTabs').addEventListener('click', (e) => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    const room = btn.dataset.room;

    // update active state
    document.querySelectorAll('#roomTabs .tab').forEach(t => {
      const isActive = (t === btn);
      t.classList.toggle('is-active', isActive);
      t.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });

    setRoomVisibility(room);
    // optional: refresh events scoped to the current view window
    loadFromBackend();
  });

  // optional keyboard nav (←/→ to move between tabs)
  document.getElementById('roomTabs').addEventListener('keydown', (e) => {
    if (!['ArrowLeft','ArrowRight'].includes(e.key)) return;
    const tabs = [...document.querySelectorAll('#roomTabs .tab')];
    const idx = tabs.findIndex(t => t.classList.contains('is-active'));
    const next = e.key === 'ArrowRight' ? (idx + 1) % tabs.length : (idx - 1 + tabs.length) % tabs.length;
    tabs[next].focus();
    tabs[next].click();
    e.preventDefault();
  });

  /* ---------- Create (drag-select triggers our modal) ---------- */
  calendar.on('beforeCreateSchedule', async ev => {
    const { start, end } = ev;
    const calId = ev.calendarId || (calDefs.find(c => calendar.isVisibleCalendar(c.id)) || calDefs[0]).id;
  
    // (optional) conflict check...
  
    const newId = uuid();
    calendar.createSchedules([{ id:newId, calendarId:calId, title: ev.title || 'Booking',
      category:'time', start, end, isReadOnly:false }]);
    ev.guide?.clearGuideElement?.();
  
    try {
      const res  = await postSimple({ action:'create', event:{
        id:newId, calendarId:calId,
        title: ev.title || 'Booking',
        start: toJSDate(start).toISOString(),
        end:   toJSDate(end).toISOString()
      }});
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'create failed');
  
      // If backend rewrote the id (it shouldn't, but be robust)
      if (json.id && json.id !== newId) {
        calendar.deleteSchedule(newId, calId);
        calendar.createSchedules([{ id:json.id, calendarId:calId, title: ev.title || 'Booking',
          category:'time', start, end, isReadOnly:false }]);
      }
    } catch (e) {
      alert('Create failed: ' + e.message);
      calendar.deleteSchedule(newId, calId);
    } finally {
      loadFromBackend();
    }
  });

  /* ---------- Click to Edit ---------- */
  calendar.on('clickSchedule', ({ schedule })=>{
    const start = schedule.start.toDate(), end = schedule.end.toDate();
    const [room,hood] = schedule.calendarId.split('-');
    // Extract a name from the title if it follows "Name — TCx/Hood y"
    const nameGuess = schedule.title?.split(' — ')[0] || '';
    openModal('Edit Booking', {
      mode:'edit',
      name: nameGuess,
      date: toLocalDateInputValue(start),
      start: toLocalTimeInputValue(start),
      end: toLocalTimeInputValue(end),
      room, hood
    });
    editing = { id:schedule.id, calendarId:schedule.calendarId, start:schedule.start, end:schedule.end, raw:{name:nameGuess,room,hood} };
  });

  /* ---------- Drag / move / resize existing event ---------- */
  calendar.on('beforeUpdateSchedule', async ev => {
    const { schedule, changes } = ev;
    const newCalId = changes.calendarId || schedule.calendarId;
    const newStart = changes.start || schedule.start;
    const newEnd   = changes.end   || schedule.end;
    const newTitle = (changes.title ?? schedule.title);
  
    // optimistic UI
    calendar.updateSchedule(schedule.id, schedule.calendarId, {
      ...changes,
      calendarId: newCalId   // <- be explicit
    });
  
    try {
      const res = await postSimple({ action:'update', event:{
        id: schedule.id,
        calendarId: newCalId,
        start: toJSDate(newStart).toISOString(),
        end:   toJSDate(newEnd).toISOString(),
        title: newTitle
      }});
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'update failed');
    } catch (e) {
      alert('Update failed: ' + e.message);
    } finally {
      loadFromBackend(); // re-sync with server truth
    }
  });

  /* ---------- Modal buttons ---------- */
  cancelBtn.onclick = ()=>{ editing=null; closeModal(); };

  deleteBtn.onclick = async ()=>{
    if (!editing?.id || BUSY) return;
    BUSY = true;
    try{
      Cal.remove(editing.id, editing.calendarId);
      await postSimple({ action:'delete', event:{ id: editing.id } });
    } finally{
      BUSY = false; editing=null; closeModal(); loadFromBackend();
    }
  };

  saveBtn.onclick = async ()=>{
    if (BUSY) return;
    const name = nameEl.value.trim();
    const room = roomEl.value;
    const hood = hoodEl.value;
    const date = dateEl.value;
    const sTime = startEl.value;
    const eTime = endEl.value;
    if (!date || !sTime || !eTime) { alert('Please pick a date and start/end times.'); return; }

    const start = buildDate(date, sTime);
    const end   = buildDate(date, eTime);
    const calendarId = `${room}-${hood}`;
    const title = titleFor(name, room, hood);

    if (end <= start) { alert('End time must be after start time.'); return; }
    const ignoreId = editing?.id || null;
    if (hasConflict(calendarId, start, end, ignoreId)) { alert('There is already a booking on that hood during this time.'); return; }

    BUSY = true;
    try{
      if (editing && editing.id){
        // EDIT
        Cal.update(editing.id, editing.calendarId, {
          title, start, end, calendarId
        });
        await postSimple({
          action:'update',
          event:{
            id: editing.id,
            calendarId,
            title,
            start: start.toISOString(),
            end:   end.toISOString()
          }
        });
      } else {
        // CREATE
        const id = uuid();
        Cal.add([{ id, calendarId, title, category:'time', start, end, isReadOnly:false }]);
        await postSimple({
          action:'create',
          event:{
            id,
            calendarId,
            title,
            start: start.toISOString(),
            end:   end.toISOString()
          }
        });
      }
    } finally{
      BUSY = false; editing=null; closeModal(); loadFromBackend();
    }
  };

  // Initial load
  setTimeout(loadFromBackend, 0);
</script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Riley Lab – TC Hood Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TUI Calendar v1 + deps (order matters) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.css">

  <script src="https://cdn.jsdelivr.net/npm/tui-code-snippet@1.5.2/dist/tui-code-snippet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --TC1:#2563eb; --TC2:#16a34a; --TC3:#f59e0b;
      --TC1b:#60a5fa; --TC1c:#93c5fd;
      --TC2b:#22c55e; --TC2c:#86efac;
      --TC3b:#fbbf24; --TC3c:#fde68a;
      --ink:#111827;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .toolbar button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .title{margin-left:auto;font-weight:600}

    /* Room tabs */
    .room-tabs{display:flex;gap:10px;margin:8px 0 14px}
    .room-tab{padding:10px 16px;border:1px solid var(--border);background:#fff;border-radius:12px;cursor:pointer;font-weight:700}
    .room-tab.active{background:var(--ink);color:#fff;border-color:var(--ink)}
    .room-hint{color:var(--muted);font-size:12px;margin:-8px 0 10px}

    #calendar{height:72vh;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .legend{margin-top:8px;color:var(--muted)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:380px;background:#fff;border-radius:12px;border:1px solid var(--border);box-shadow:0 10px 30px #0003;padding:16px}
    .modal h3{margin:0 0 10px}
    .row{display:flex;gap:10px;margin:8px 0}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input, select{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}

    /* UX hint: double-click to create */
    .tui-full-calendar-timegrid-container{cursor:cell}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button id="prev">‹</button>
      <button id="today">Today</button>
      <button id="next">›</button>
      <button id="week">Week</button>
      <button id="day">Day</button>
      <div class="title" id="range"></div>
    </div>

    <div class="room-tabs" id="roomTabs"></div>
    <div class="room-hint">Double-click in the grid to create. Drag/resize to edit. Press Delete to remove.</div>

    <div id="calendar"></div>
    <div class="legend">Tip: use the tabs to switch rooms. Only that room’s three hoods are shown.</div>
  </div>

  <!-- Custom create modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <h3 id="mTitle">Create booking</h3>
      <div class="row">
        <div style="flex:2">
          <label>Name</label>
          <input id="mName" placeholder="Your name" />
        </div>
        <div style="flex:1">
          <label>Room</label>
          <select id="mRoom">
            <option value="TC1">TC1</option>
            <option value="TC2">TC2</option>
            <option value="TC3">TC3</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Hood</label>
          <select id="mHood">
            <option value="1">Hood 1</option>
            <option value="2">Hood 2</option>
            <option value="3">Hood 3</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="mCancel">Cancel</button>
        <button class="btn primary" id="mCreate">Create</button>
      </div>
    </div>
  </div>

  <script>
    /********* SET YOUR APPS SCRIPT WEB APP URL HERE *********/
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwzkzB0tuX-1jtCrF0byVzWGhKkH_4Sko6RYImOQ48LSnZwuy7SCVgkC01_t_Ja2otS/exec';
    /*********************************************************/

    // 9 hood calendars (3 per room) with distinct colors
    const calDefs = [
      ['TC1','1','var(--TC1)'], ['TC1','2','var(--TC1b)'], ['TC1','3','var(--TC1c)'],
      ['TC2','1','var(--TC2)'], ['TC2','2','var(--TC2b)'], ['TC2','3','var(--TC2c)'],
      ['TC3','1','var(--TC3)'], ['TC3','2','var(--TC3b)'], ['TC3','3','var(--TC3c)'],
    ].map(([room,hood,color]) => ({
      id: `${room}-${hood}`,
      name: `${room}/Hood ${hood}`,
      color: '#fff',
      bgColor: getComputedStyle(document.documentElement).getPropertyValue(color).trim()
    }));

    // Calendar (TUI v1) — disable default create popup; use double-click + custom modal
    const calendar = new tui.Calendar(document.getElementById('calendar'), {
      defaultView: 'week',
      taskView: false,
      scheduleView: ['time'],
      useCreationPopup: false,    // custom modal instead
      useDetailPopup: true,
      isReadOnly: false,
      disableClick: true,         // block single-click creation
      disableDblClick: false,     // allow double-click
      week: { hourStart: 8, hourEnd: 20, workweek: true, narrowWeekend: true, startDayOfWeek: 1 },
      calendars: calDefs
    });

    // --- Helpers (v1 & general) ---
    const Cal = {
      getAll(){ return calendar.getSchedules ? calendar.getSchedules() : []; },
      clear(){ if (calendar.clear) return calendar.clear(); },
      add(arr){ if (calendar.createSchedules) return calendar.createSchedules(arr); },
      update(id, calId, changes){ if (calendar.updateSchedule) return calendar.updateSchedule(id, calId, changes); },
      remove(id, calId){ if (calendar.deleteSchedule) return calendar.deleteSchedule(id, calId); },
      visible(calId, vis){ if (calendar.setCalendarVisibility) return calendar.setCalendarVisibility(calId, vis); }
    };
    const toJSDate = x => (x && x.toDate) ? x.toDate() : (x instanceof Date ? x : new Date(x));
    const overlaps = (aStart,aEnd,bStart,bEnd)=> aStart < bEnd && bStart < aEnd;
    function hasConflict(calendarId, startLike, endLike, ignoreId){
      const start = toJSDate(startLike), end = toJSDate(endLike);
      return Cal.getAll().some(ev=>{
        if (ev.calendarId !== calendarId) return false;
        if (ignoreId && ev.id === ignoreId) return false;
        return overlaps(start, end, toJSDate(ev.start), toJSDate(ev.end));
      });
    }
    const uuid = ()=>'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
      const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
    });
    function postSimple(payload){
      return fetch(ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain' }, // keep request "simple" -> no preflight
        credentials:'omit',
        body: JSON.stringify(payload)
      });
    }

    // --- Room tabs (only room-level toggles) ---
    let activeRoom = 'TC1';
    const roomTabsEl = document.getElementById('roomTabs');
    ['TC1','TC2','TC3'].forEach(room=>{
      const b = document.createElement('button');
      b.className = 'room-tab' + (room===activeRoom ? ' active' : '');
      b.textContent = room;
      b.onclick = () => setActiveRoom(room);
      roomTabsEl.appendChild(b);
    });
    function setActiveRoom(room){
      activeRoom = room;
      [...roomTabsEl.children].forEach(ch => ch.classList.toggle('active', ch.textContent===room));
      ['TC1','TC2','TC3'].forEach(r=>{
        ['1','2','3'].forEach(h=> Cal.visible(`${r}-${h}`, r===room));
      });
    }
    setActiveRoom(activeRoom);

    // --- Toolbar date range title ---
    function setRangeTitle(){
      const s = calendar.getDateRangeStart().toDate();
      const e = calendar.getDateRangeEnd().toDate();
      document.getElementById('range').textContent =
        `${s.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${e.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
    }
    setRangeTitle();
    prev.onclick  = ()=>{ calendar.prev();  setRangeTitle(); loadFromBackend(); };
    today.onclick = ()=>{ calendar.today(); setRangeTitle(); loadFromBackend(); };
    next.onclick  = ()=>{ calendar.next();  setRangeTitle(); loadFromBackend(); };
    week.onclick  = ()=>{ calendar.changeView('week', true); setRangeTitle(); loadFromBackend(); };
    day.onclick   = ()=>{ calendar.changeView('day',  true); setRangeTitle(); loadFromBackend(); };

    // --- Custom modal wiring ---
    const modal = {
      el: document.getElementById('modalBackdrop'),
      name: document.getElementById('mName'),
      room: document.getElementById('mRoom'),
      hood: document.getElementById('mHood'),
      open(ctx){ // {start,end}
        this.name.value = '';
        this.room.value = activeRoom;
        this.hood.value = '1';
        this._ctx = ctx;
        this.el.style.display = 'flex';
        this.name.focus();
      },
      close(){ this.el.style.display = 'none'; this._ctx = null; }
    };
    document.getElementById('mCancel').onclick = ()=>modal.close();
    document.getElementById('mCreate').onclick = async ()=>{
      const name = modal.name.value.trim();
      if (!name) { modal.name.focus(); return; }
      const room = modal.room.value;
      const hood = modal.hood.value;
      const calId = `${room}-${hood}`;
      const { start, end } = modal._ctx;

      if (hasConflict(calId, start, end)) { alert('Time overlaps an existing booking on that hood.'); return; }

      const id = uuid();
      const title = `${name} — ${room}/Hood ${hood}`;

      // Optimistic add (do not reload yet)
      Cal.add([{ id, calendarId: calId, title, category:'time', start, end, isReadOnly:false }]);
      modal.close();

      try {
        const res = await postSimple({ action:'create', event:{
          id, calendarId: calId, title,
          start: toJSDate(start).toISOString(),
          end:   toJSDate(end).toISOString()
        }});
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Create failed');
        loadFromBackend(); // refresh once server confirmed
      } catch (e) {
        console.warn('Create failed:', e.message);
        // Keep the optimistic event so it doesn't vanish.
      }
    };

    // Double-click to open modal; block drag-creation’s popup
    calendar.on('beforeCreateSchedule', ev => {
      if (ev.triggerEventName !== 'dblclick') { ev.guide?.clearGuideElement?.(); return; }
      modal.open({ start: ev.start, end: ev.end });
      ev.guide?.clearGuideElement?.();
    });

    // Update (drag/resize or edit title) — keeps same id, no duplicates
    calendar.on('beforeUpdateSchedule', async ev => {
      const { schedule, changes } = ev;
      const newCalId = changes.calendarId || schedule.calendarId;
      const newStart = changes.start || schedule.start;
      const newEnd   = changes.end   || schedule.end;
      const newTitle = (changes.title ?? schedule.title);

      if (hasConflict(newCalId, newStart, newEnd, schedule.id)) {
        alert('Conflict: another booking exists on that hood/time.');
        return;
      }

      // Optimistic UI
      Cal.update(schedule.id, schedule.calendarId, changes);

      try {
        const res = await postSimple({ action:'update', event:{
          id: schedule.id,
          calendarId: newCalId,
          start: toJSDate(newStart).toISOString(),
          end:   toJSDate(newEnd).toISOString(),
          title: newTitle
        }});
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Update failed');
        loadFromBackend();
      } catch (e) {
        console.warn('Update failed:', e.message);
        loadFromBackend(); // restore server’s truth if needed
      }
    });

    // Delete
    calendar.on('beforeDeleteSchedule', async ({ schedule }) => {
      Cal.remove(schedule.id, schedule.calendarId); // optimistic
      try {
        const res = await postSimple({ action:'delete', event:{ id: schedule.id } });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Delete failed');
        loadFromBackend();
      } catch (e) {
        console.warn('Delete failed:', e.message);
        loadFromBackend();
      }
    });

    // Load from backend
    async function loadFromBackend(){
      try{
        const s = calendar.getDateRangeStart().toDate().toISOString();
        const e = calendar.getDateRangeEnd().toDate().toISOString();
        const res = await fetch(`${ENDPOINT}?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}`);
        const json = await res.json();
        if (!Array.isArray(json)) { console.warn('Backend returned', json); return; }
        Cal.clear();
        Cal.add(json.map(x => ({
          id:x.id, calendarId:x.calendarId, title:x.title,
          category:'time', start:new Date(x.start), end:new Date(x.end), isReadOnly:false
        })));
        setActiveRoom(activeRoom); // re-apply room filter
      }catch(err){ console.error('loadFromBackend failed:', err); }
    }
    setTimeout(loadFromBackend, 0);
  </script>
</body>
</html>

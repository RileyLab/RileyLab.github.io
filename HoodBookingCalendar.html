<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Riley Lab – TC Hood Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TUI Calendar v1 + deps (include exactly in this order) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.css">

  <script src="https://cdn.jsdelivr.net/npm/tui-code-snippet@1.5.2/dist/tui-code-snippet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      /* big room hues so they’re obviously different */
      --TC1:#2563eb; --TC2:#16a34a; --TC3:#f59e0b;
      --TC1b:#60a5fa; --TC1c:#93c5fd; 
      --TC2b:#22c55e; --TC2c:#86efac;
      --TC3b:#fbbf24; --TC3c:#fde68a;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .toolbar button{padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
    .title{margin-left:auto;font-weight:600}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 16px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;box-shadow:0 0 0 2px #fff,inset 0 0 0 1px #0001}
    #calendar{height:72vh;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .legend{margin-top:8px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button id="prev">‹</button>
    <button id="today">Today</button>
    <button id="next">›</button>
    <button id="week">Week</button>
    <button id="day">Day</button>
    <div class="title" id="range"></div>
  </div>

  <!-- Room filters -->
  <div class="chips" id="roomFilters">
    <label class="chip"><input type="checkbox" data-room="TC1" checked> <span class="dot" style="background:var(--TC1)"></span> TC1</label>
    <label class="chip"><input type="checkbox" data-room="TC2" checked> <span class="dot" style="background:var(--TC2)"></span> TC2</label>
    <label class="chip"><input type="checkbox" data-room="TC3" checked> <span class="dot" style="background:var(--TC3)"></span> TC3</label>
  </div>

  <!-- Hood filters -->
  <div class="chips" id="hoodFilters">
    <label class="chip"><input type="checkbox" data-cal="TC1-1" checked> <span class="dot" style="background:var(--TC1)"></span> TC1 / Hood 1</label>
    <label class="chip"><input type="checkbox" data-cal="TC1-2" checked> <span class="dot" style="background:var(--TC1b)"></span> TC1 / Hood 2</label>
    <label class="chip"><input type="checkbox" data-cal="TC1-3" checked> <span class="dot" style="background:var(--TC1c)"></span> TC1 / Hood 3</label>
    <label class="chip"><input type="checkbox" data-cal="TC2-1" checked> <span class="dot" style="background:var(--TC2)"></span> TC2 / Hood 1</label>
    <label class="chip"><input type="checkbox" data-cal="TC2-2" checked> <span class="dot" style="background:var(--TC2b)"></span> TC2 / Hood 2</label>
    <label class="chip"><input type="checkbox" data-cal="TC2-3" checked> <span class="dot" style="background:var(--TC2c)"></span> TC2 / Hood 3</label>
    <label class="chip"><input type="checkbox" data-cal="TC3-1" checked> <span class="dot" style="background:var(--TC3)"></span> TC3 / Hood 1</label>
    <label class="chip"><input type="checkbox" data-cal="TC3-2" checked> <span class="dot" style="background:var(--TC3b)"></span> TC3 / Hood 2</label>
    <label class="chip"><input type="checkbox" data-cal="TC3-3" checked> <span class="dot" style="background:var(--TC3c)"></span> TC3 / Hood 3</label>
  </div>

  <div id="calendar"></div>
  <div class="legend">Drag to create, click to edit, press Delete to remove.</div>
</div>

<script>
  // When you wire the backend, set ENDPOINT to your Apps Script Web App URL.
  const ENDPOINT = 'https://script.googleusercontent.com/macros/exec?service=AKfycbwzkzB0tuX-1jtCrF0byVzWGhKkH_4Sko6RYImOQ48LSnZwuy7SCVgkC01_t_Ja2otS';
  // ===========================

  // 9 calendars: TC1..3 × hood 1..3 with strong room colors
  const calDefs = [
    ['TC1','1','var(--TC1)'], ['TC1','2','var(--TC1b)'], ['TC1','3','var(--TC1c)'],
    ['TC2','1','var(--TC2)'], ['TC2','2','var(--TC2b)'], ['TC2','3','var(--TC2c)'],
    ['TC3','1','var(--TC3)'], ['TC3','2','var(--TC3b)'], ['TC3','3','var(--TC3c)'],
  ].map(([room,hood,color]) => ({
    id: `${room}-${hood}`,
    name: `${room}/Hood ${hood}`,
    color: '#fff',
    bgColor: getComputedStyle(document.documentElement).getPropertyValue(color).trim()
  }));

  const calEl = document.getElementById('calendar');

  // Detect API surface once
  const isV1 = !!(tui?.Calendar?.prototype?.getSchedules);
  const isV2 = !!(tui?.Calendar?.prototype?.getEvents);
  
  // Uniform getters so our logic works on either version
  function getAllEvents() {
    if (isV1) return calendar.getSchedules();
    if (isV2) return calendar.getEvents();
    return [];
  }
  
  const calendar = new tui.Calendar(document.getElementById('calendar'), {
    defaultView: 'week',
    taskView: false,
    scheduleView: ['time'],
    useCreationPopup: true,
    useDetailPopup: true,
    isReadOnly: false,
    week: { hourStart: 8, hourEnd: 20, workweek: true, narrowWeekend: true, startDayOfWeek: 1 },
    calendars: calDefs
  });

  console.log('tui version check', !!tui && !!tui.Calendar); // should be true

  // Add a 1-hour test block “now”
  const now = new Date();
  const later = new Date(now.getTime() + 60*60*1000);
  calendar.createSchedules([{
    id: 'test-1',
    calendarId: 'TC1-1',       // one of your defined calendars
    title: 'Test booking',
    category: 'time',
    start: now,
    end: later,
    isReadOnly: false
  }]);

  // --- Title bar ---
  function setRangeTitle(){
    const s = calendar.getDateRangeStart().toDate();
    const e = calendar.getDateRangeEnd().toDate();
    document.getElementById('range').textContent =
      `${s.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${e.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
  }
  setRangeTitle();

  // --- Toolbar wiring ---
  document.getElementById('prev').onclick  = () => { calendar.prev();  setRangeTitle(); loadFromBackend(); };
  document.getElementById('today').onclick = () => { calendar.today(); setRangeTitle(); loadFromBackend(); };
  document.getElementById('next').onclick  = () => { calendar.next();  setRangeTitle(); loadFromBackend(); };
  document.getElementById('week').onclick  = () => { calendar.changeView('week', true); setRangeTitle(); loadFromBackend(); };
  document.getElementById('day').onclick   = () => { calendar.changeView('day',  true); setRangeTitle(); loadFromBackend(); };


  // --- Filters (v1 visibility APIs) ---
  document.querySelectorAll('#roomFilters input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const room = e.target.dataset.room;
      ['1','2','3'].forEach(h => calendar.setCalendarVisibility(`${room}-${h}`, e.target.checked));
      document.querySelectorAll(`#hoodFilters input[data-cal^="${room}-"]`).forEach(hcb => { hcb.checked = e.target.checked; });
    });
  });
  document.querySelectorAll('#hoodFilters input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      calendar.setCalendarVisibility(e.target.dataset.cal, e.target.checked);
      const room = e.target.dataset.cal.split('-')[0];
      const any  = [...document.querySelectorAll(`#hoodFilters input[data-cal^="${room}-"]`)].some(x => x.checked);
      document.querySelector(`#roomFilters input[data-room="${room}"]`).checked = any;
    });
  });

  // --- Helper: conflict detection on the same hood (calendarId) ---
  function overlaps(aStart, aEnd, bStart, bEnd) {
    // all are moment() in v1
    return aStart.isBefore(bEnd) && bStart.isBefore(aEnd);
  }
  function hasConflict(calId, start, end, ignoreId) {
    const schedules = calendar.getSchedules();
    return schedules.some(s => {
      if (s.calendarId !== calId) return false;
      if (ignoreId && s.id === ignoreId) return false;
      return overlaps(s.start, s.end, start, end);
    });
  }

  // --- Create from popup (v1 event name) ---
  calendar.on('beforeCreateSchedule', async ev => {
    const { start, end } = ev;      // moment() objects
    const calId = ev.calendarId || 'TC1-1';  // simple safe default

    if (hasConflict(calId, start, end)) {
      alert('Time overlaps an existing booking on that hood.');
      ev.guide.clearGuideElement(); 
      return;
    }

    const tempId = 'tmp-' + Date.now();
    calendar.createSchedules([{ id: tempId, calendarId: calId, title: ev.title || 'Booking',
                                category:'time', start, end, isReadOnly:false }]);
    ev.guide.clearGuideElement();

    try {
      await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },   // <- important: no preflight
        body: JSON.stringify({
          action: 'create',
          event: { calendarId: calId, title: ev.title || 'Booking',
                   start: start.toDate().toISOString(),
                   end:   end.toDate().toISOString() }
        })
      });
      const json = await res.json();
      if (json.ok && json.id) {
        calendar.deleteSchedule(tempId, calId);
        calendar.createSchedules([{ id: json.id, calendarId: calId, title: ev.title || 'Booking',
                                    category:'time', start, end, isReadOnly:false }]);
      } else {
        alert(json.error || 'Failed to save. Reverting.');
        calendar.deleteSchedule(tempId, calId);
      }
    } catch (e) {
      alert('Network error. Reverting.');
      calendar.deleteSchedule(tempId, calId);
    } finally {
      loadFromBackend();
    }
  });
  
  // --- Update / move / resize ---
  calendar.on('beforeUpdateSchedule', async ev => {
    const { schedule, changes } = ev;
    const newCalId = changes.calendarId || schedule.calendarId;
    const newStart = changes.start || schedule.start;  // moment()
    const newEnd   = changes.end   || schedule.end;

    if (hasConflict(newCalId, newStart, newEnd, schedule.id)) {
      alert('Conflict: another booking exists on that hood/time.');
      return;
    }

    calendar.updateSchedule(schedule.id, schedule.calendarId, changes);

    try {
      await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },   // <- important: no preflight
        body: JSON.stringify({
          action: 'create',
          event: { calendarId: calId, title: ev.title || 'Booking',
                   start: start.toDate().toISOString(),
                   end:   end.toDate().toISOString() }
        })
      });
      const json = await res.json();
      if (!json.ok) { alert(json.error || 'Update failed'); loadFromBackend(); }
    } catch {
      alert('Network error'); loadFromBackend();
    }
  });

  // --- Delete ---
  calendar.on('beforeDeleteSchedule', async ({ schedule }) => {
    try {
      // send JSON (we’ll allow preflight on the backend)
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },   // <- important
        body: JSON.stringify({ action: 'delete', event: { id: schedule.id } })
      });
  
      // Important: Apps Script sometimes returns 200 with an HTML error
      // so force JSON parse inside try/catch:
      let json;
      try { json = await res.json(); } catch (e) { throw new Error('Non-JSON response from server'); }
  
      if (json.ok) {
        calendar.deleteSchedule(schedule.id, schedule.calendarId); // immediate UI update
      } else {
        alert(json.error || 'Delete failed on server');
        // optional: reload calendar to stay consistent
        loadFromBackend();
      }
    } catch (err) {
      console.error('Delete error:', err);
      alert('Network/CORS error while deleting');
      loadFromBackend();
    }
  });

  // --- Load from backend ---
  async function loadFromBackend(){
    try {
      const s = calendar.getDateRangeStart().toDate().toISOString();
      const e = calendar.getDateRangeEnd().toDate().toISOString();
      const res = await fetch(`${ENDPOINT}?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}`);
      const json = await res.json();
      if (!Array.isArray(json)) {
        console.warn('Backend returned non-array:', json);
        return;
      }
      calendar.clear();
      calendar.createSchedules(json.map(x => ({
        id: x.id, calendarId: x.calendarId, title: x.title, category: 'time',
        start: new Date(x.start), end: new Date(x.end), isReadOnly: false
      })));
    } catch (err) {
      console.error('loadFromBackend failed:', err);
    }
  }
  loadFromBackend();
  
</script>
</body>
</html>

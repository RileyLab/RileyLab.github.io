<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Riley Lab – TC Hood Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TUI Calendar v1 + deps -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tui-code-snippet@1.5.2/dist/tui-code-snippet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.6/dist/tui-time-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-calendar@1.12.14/dist/tui-calendar.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --TC1:#2563eb; --TC2:#16a34a; --TC3:#f59e0b;
      --TC1b:#60a5fa; --TC1c:#93c5fd; 
      --TC2b:#22c55e; --TC2c:#86efac;
      --TC3b:#fbbf24; --TC3c:#fde68a;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .btn{padding:10px 14px;border:1px solid var(--border);background:#fff;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .title{margin-left:auto;font-weight:700;font-size:16px}

    /* BIG Tabs */
    .tabs{display:flex;gap:12px;margin:14px 0 18px}
    .tab{
      flex:0 0 auto; min-width:140px; padding:14px 18px;
      border-radius:999px; border:2px solid var(--border); background:#fff;
      font-weight:800; letter-spacing:.2px; text-align:center; box-shadow:var(--shadow);
      cursor:pointer; user-select:none; transition:transform .05s ease;
    }
    .tab:active{transform:translateY(1px)}
    .tab .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:8px;vertical-align:middle}
    .tab[data-room="TC1"] .dot{background:var(--TC1)}
    .tab[data-room="TC2"] .dot{background:var(--TC2)}
    .tab[data-room="TC3"] .dot{background:var(--TC3)}
    .tab.active{border-color:#111827; color:#111827}
    .tab.active[data-room="TC1"]{box-shadow:0 0 0 4px rgba(37,99,235,.12), var(--shadow)}
    .tab.active[data-room="TC2"]{box-shadow:0 0 0 4px rgba(22,163,74,.12), var(--shadow)}
    .tab.active[data-room="TC3"]{box-shadow:0 0 0 4px rgba(245,158,11,.15), var(--shadow)}

    #calendar{height:72vh;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .legend{margin-top:8px;color:var(--muted)}

    /* Modal — refined */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(600px,94vw);background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.18);padding:22px}
    .modal h3{margin:0 0 16px 0;font-size:22px;line-height:1.2;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:12px}
    label{font-size:12px;color:#374151;margin-bottom:6px;display:block;font-weight:600}
    input[type="text"], input[type="date"], input[type="time"], select{
      width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;outline:none
    }
    input:focus, select:focus{border-color:#111827; box-shadow:0 0 0 3px rgba(17,24,39,.08)}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:18px}
    .btn.danger{background:#b91c1c;color:#fff;border-color:#b91c1c}
    .btn.muted{background:#f3f4f6;border-color:#e5e7eb}

    /* Spinner + Toast (center) */
    #spinner{
      position:fixed;right:16px;bottom:16px;padding:6px 10px;border:1px solid var(--border);
      background:#fff;border-radius:10px;box-shadow:var(--shadow);display:none;z-index:99999
    }
    #toast{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      min-width:280px;max-width:80vw;padding:14px 16px;border-radius:14px;border:1px solid var(--border);
      display:none;align-items:center;justify-content:center;background:#fff;box-shadow:0 20px 60px rgba(0,0,0,.18);
      font-weight:700;z-index:100000
    }
    #toast.ok{border-color:#16a34a}
    #toast.warn{border-color:#b45309}
    #toast.err{border-color:#b91c1c}
    .hidden{display:none !important}
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button class="btn" id="prev">‹</button>
    <button class="btn" id="today">Today</button>
    <button class="btn" id="next">›</button>
    <button class="btn" id="week">Week</button>
    <button class="btn" id="day">Day</button>
    <div class="title" id="range"></div>
    <button class="btn primary" id="newBooking">+ New booking</button>
  </div>

  <!-- BIG room tabs -->
  <div class="tabs" id="roomTabs">
    <div class="tab active" data-room="TC1"><span class="dot"></span>TC1</div>
    <div class="tab" data-room="TC2"><span class="dot"></span>TC2</div>
    <div class="tab" data-room="TC3"><span class="dot"></span>TC3</div>
  </div>

  <div id="calendar"></div>
  <div class="legend">Drag to select a time range to create. Drag/resize an event to edit. Click an event to edit or delete.</div>
</div>

<!-- Spinner & Toast -->
<div id="spinner">Saving…</div>
<div id="toast"></div>

<!-- Modal (Create/Edit) -->
<div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true">
  <div class="modal" id="modalCard">
    <h3 id="modalTitle">New Booking</h3>
    <div class="grid">
      <div>
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Your name">
      </div>
      <div>
        <label for="date">Date</label>
        <input id="date" type="date">
      </div>
      <div>
        <label for="start">Start time</label>
        <input id="start" type="time" step="900">
      </div>
      <div>
        <label for="end">End time</label>
        <input id="end" type="time" step="900">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div style="flex:1">
        <label for="room">Room</label>
        <select id="room" disabled>
          <option value="TC1">TC1</option>
          <option value="TC2">TC2</option>
          <option value="TC3">TC3</option>
        </select>
      </div>
      <div style="flex:1">
        <label for="hood">Hood</label>
        <select id="hood">
          <option value="1">Hood 1</option>
          <option value="2">Hood 2</option>
          <option value="3">Hood 3</option>
        </select>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn muted" id="cancelBtn">Cancel</button>
      <button class="btn danger" id="deleteBtn" style="display:none">Delete</button>
      <button class="btn primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
  /********* UPDATE THIS LINE WITH YOUR CURRENT /exec URL *********/
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwzkzB0tuX-1jtCrF0byVzWGhKkH_4Sko6RYImOQ48LSnZwuy7SCVgkC01_t_Ja2otS/exec';
  /****************************************************************/

  // Calendar definitions (colors)
  const calDefs = [
    ['TC1','1','var(--TC1)'], ['TC1','2','var(--TC1b)'], ['TC1','3','var(--TC1c)'],
    ['TC2','1','var(--TC2)'], ['TC2','2','var(--TC2b)'], ['TC2','3','var(--TC2c)'],
    ['TC3','1','var(--TC3)'], ['TC3','2','var(--TC3b)'], ['TC3','3','var(--TC3c)'],
  ].map(([room,hood,color]) => ({
    id: `${room}-${hood}`,
    name: `${room}/Hood ${hood}`,
    color: '#fff',
    bgColor: getComputedStyle(document.documentElement).getPropertyValue(color).trim()
  }));

  const calendar = new tui.Calendar(document.getElementById('calendar'), {
    defaultView: 'week',
    taskView: false,
    scheduleView: ['time'],
    useCreationPopup: false,
    useDetailPopup: false,
    isReadOnly: false,
    week: { hourStart: 2, hourEnd: 24, workweek: false, narrowWeekend: true, startDayOfWeek: 1 },
    calendars: calDefs
  });

  /* ---------- Helper handles ---------- */
  const Cal = {
    add(arr){ return calendar.createSchedules(arr); },
    update(id, calId, changes){ return calendar.updateSchedule(id, calId, changes); },
    remove(id, calId){ return calendar.deleteSchedule(id, calId); },
    clear(){ return calendar.clear(); },
    visible(calId, vis){ return calendar.setCalendarVisibility(calId, vis); },
    all(){ return calendar.getSchedules ? calendar.getSchedules() : []; }
  };

  function setRangeTitle(){
    const s = calendar.getDateRangeStart().toDate();
    const e = calendar.getDateRangeEnd().toDate();
    document.getElementById('range').textContent =
      `${s.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${e.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
  }

  // UI refs
  const modalBg   = document.getElementById('modalBg');
  const modalTitle= document.getElementById('modalTitle');
  const nameEl    = document.getElementById('name');
  const dateEl    = document.getElementById('date');
  const startEl   = document.getElementById('start');
  const endEl     = document.getElementById('end');
  const roomEl    = document.getElementById('room'); // locked
  const hoodEl    = document.getElementById('hood');
  const saveBtn   = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const spinner   = document.getElementById('spinner');
  const newBtn    = document.getElementById('newBooking');
  const toastEl   = document.getElementById('toast');

  let BUSY = false;
  let editing = null; // {id, calendarId, ...}
  let activeRoom = 'TC1';

  // Super-snappy UX helpers
  function showSpin(v){ spinner.style.display = v ? 'block' : 'none'; }
  function toast(msg, type='ok', ms=1700){
    toastEl.className = ''; toastEl.classList.add(type);
    toastEl.textContent = msg; toastEl.style.display='flex';
    clearTimeout(toastEl._t); toastEl._t = setTimeout(()=>toastEl.style.display='none', ms);
  }
  function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)}) }
  function openModal(title, preset){
    modalTitle.textContent = title;
    modalBg.style.display = 'flex';
    nameEl.value  = preset?.name || '';
    dateEl.value  = preset?.date || '';
    startEl.value = preset?.start || '';
    endEl.value   = preset?.end || '';
    roomEl.value  = preset?.room || activeRoom || 'TC1';
    roomEl.disabled = true; // LOCKED to active tab
    hoodEl.value  = preset?.hood || '1';
    deleteBtn.style.display = preset?.mode === 'edit' ? 'inline-block' : 'none';
    setTimeout(()=>nameEl.focus(), 0);
  }
  function closeModal(){ modalBg.style.display = 'none'; }

  function toLocalDateInputValue(d){ const t = new Date(d); t.setMinutes(t.getMinutes()-t.getTimezoneOffset()); return t.toISOString().slice(0,10); }
  function toLocalTimeInputValue(d){ const t = new Date(d); t.setMinutes(t.getMinutes()-t.getTimezoneOffset()); return t.toISOString().slice(11,16); }
  function buildDate(dateStr, timeStr){ const [y,m,d]=dateStr.split('-').map(Number); const [hh,mm]=timeStr.split(':').map(Number); return new Date(y,m-1,d,hh,mm,0,0); }
  function titleFor(name, room, hood){ return `${name || 'Booking'} — ${room}/Hood ${hood}`; }

  /* ---------- FAST data layer (range cache) ---------- */
  const cache = { key: null, events: [] }; // events = [{id, calendarId, title, start, end}]
  function rangeKey(){ return calendar.getDateRangeStart().toDate().toISOString() + '|' + calendar.getDateRangeEnd().toDate().toISOString(); }

  async function fetchRange(){
    const s = calendar.getDateRangeStart().toDate().toISOString();
    const e = calendar.getDateRangeEnd().toDate().toISOString();
    const res = await fetch(`${ENDPOINT}?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}&timeMin=${encodeURIComponent(s)}&timeMax=${encodeURIComponent(e)}`);
    const json = await res.json();
    return Array.isArray(json) ? json : [];
  }

  async function ensureRangeLoaded(){
    const k = rangeKey();
    if (cache.key === k && cache.events.length) return; // already loaded
    showSpin(true);
    const data = await fetchRange();
    cache.key = k;
    cache.events = data.map(x=>({ id:x.id, calendarId:x.calendarId, title:x.title, start:x.start, end:x.end }));
    // render all once
    Cal.clear();
    // avoid layout thrash: hide, add, show
    document.getElementById('calendar').style.visibility = 'hidden';
    Cal.add(cache.events.map(x=>({ id:x.id, calendarId:x.calendarId, title:x.title, category:'time', start:new Date(x.start), end:new Date(x.end), isReadOnly:false })));
    document.getElementById('calendar').style.visibility = '';
    showSpin(false);
  }

  function renderRoom(room){
    activeRoom = room;
    // Sync locked dropdown if modal is open
    if (modalBg.style.display === 'flex') roomEl.value = activeRoom;
  
    // Re-render from cache: only events for the selected room
    const toRender = cache.events.filter(e => String(e.calendarId).startsWith(`${room}-`));
  
    // Fast redraw without thrash
    Cal.clear();
    document.getElementById('calendar').style.visibility = 'hidden';
    Cal.add(toRender.map(x => ({
      id: x.id,
      calendarId: x.calendarId,
      title: x.title,
      category: 'time',
      start: new Date(x.start),
      end: new Date(x.end),
      isReadOnly: false
    })));
    document.getElementById('calendar').style.visibility = '';
  }

  /* ---------- API helper ---------- */
  async function postSimple(payload){
    const res = await fetch(ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams({ payload: JSON.stringify(payload), action: payload.action }).toString()
    });
    try { return await res.json(); } catch { return {}; }
  }

  /* ---------- Toolbar + navigation (prefetch pattern) ---------- */
  function reloadRange(){
    setRangeTitle();
    ensureRangeLoaded().then(()=> renderRoom(activeRoom));
  }
  document.getElementById('prev').onclick  = ()=>{ calendar.prev();  reloadRange(); };
  document.getElementById('today').onclick = ()=>{ calendar.today(); reloadRange(); };
  document.getElementById('next').onclick  = ()=>{ calendar.next();  reloadRange(); };
  document.getElementById('week').onclick  = ()=>{ calendar.changeView('week',true); reloadRange(); };
  document.getElementById('day').onclick   = ()=>{ calendar.changeView('day', true); reloadRange(); };

  /* ---------- Tabs ---------- */
  document.querySelectorAll('#roomTabs .tab').forEach(tab=>{
    tab.addEventListener('click', async ()=>{
      document.querySelectorAll('#roomTabs .tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      // no re-fetch: just toggle visibility
      renderRoom(tab.dataset.room);
      toast(`Viewing ${tab.dataset.room}`, 'ok', 800);
    });
  });

  /* ---------- Create ---------- */
  calendar.on('beforeCreateSchedule', ev=>{
    openModal('New Booking', {
      mode:'create',
      name:'',
      date: toLocalDateInputValue(ev.start.toDate()),
      start: toLocalTimeInputValue(ev.start.toDate()),
      end: toLocalTimeInputValue(ev.end.toDate()),
      room: activeRoom, hood:'1'
    });
    editing = { id:null };
  });

  newBtn.onclick = ()=>{
    const now = new Date(); const floor = new Date(now);
    floor.setMinutes(Math.ceil(floor.getMinutes()/30)*30,0,0);
    openModal('New Booking', {
      mode:'create',
      name:'',
      date: toLocalDateInputValue(floor),
      start: toLocalTimeInputValue(floor),
      end: toLocalTimeInputValue(new Date(floor.getTime()+60*60*1000)),
      room: activeRoom, hood:'1'
    });
    editing = { id:null };
  };

  /* ---------- Click to Edit ---------- */
  calendar.on('clickSchedule', ({ schedule })=>{
    const start = schedule.start.toDate(), end = schedule.end.toDate();
    const [room,hood] = schedule.calendarId.split('-');
    const nameGuess = schedule.title?.split(' — ')[0] || '';
    openModal('Edit Booking', {
      mode:'edit',
      name: nameGuess,
      date: toLocalDateInputValue(start),
      start: toLocalTimeInputValue(start),
      end: toLocalTimeInputValue(end),
      room, hood
    });
    editing = { id:schedule.id, calendarId:schedule.calendarId };
  });

  /* ---------- Drag/Resize Edit (server-checked, optimistic) ---------- */
  calendar.on('beforeUpdateSchedule', async (ev)=>{
    const { schedule, changes } = ev;
    const newStart = (changes.start ? changes.start.toDate() : schedule.start.toDate());
    const newEnd   = (changes.end   ? changes.end.toDate()   : schedule.end.toDate());
    const newCalId = changes.calendarId || schedule.calendarId;

    // Optimistic update
    const prev = { start:schedule.start.toDate(), end:schedule.end.toDate(), calendarId:schedule.calendarId, title:schedule.title };
    Cal.update(schedule.id, schedule.calendarId, changes);

    const resp = await postSimple({ action:'update', event:{ id: schedule.id, calendarId:newCalId, title: changes.title || schedule.title, start: newStart.toISOString(), end: newEnd.toISOString() }});
    if (!resp || resp.ok !== true){
      // revert
      Cal.update(schedule.id, newCalId, { start:new Date(prev.start), end:new Date(prev.end), calendarId:prev.calendarId, title:prev.title });
      toast(resp && resp.error === 'conflict' ? '⚠️ Conflict: that hood already has a booking.' : 'Update failed. Reverted.', resp && resp.error === 'conflict' ? 'warn' : 'err', 2200);
      return;
    }
    // update cache
    const idx = cache.events.findIndex(e=>e.id===schedule.id);
    if (idx>=0){ cache.events[idx] = { id:schedule.id, calendarId:newCalId, title: schedule.title, start:newStart.toISOString(), end:newEnd.toISOString() }; }
    toast('Updated.', 'ok', 900);
  });

  /* ---------- Modal actions ---------- */
  cancelBtn.onclick = ()=>{ editing=null; closeModal(); };

  deleteBtn.onclick = async ()=>{
    if (!editing?.id || BUSY) return;
    BUSY = true;
  
    // Optimistic: close modal and remove immediately
    const id = editing.id;
    closeModal();
    const curr = Cal.all().find(s => s.id === id);
    if (curr) Cal.remove(id, curr.calendarId);
    cache.events = cache.events.filter(e => e.id !== id);
  
    // Persist
    const res = await postSimple({ action:'delete', event:{ id } });
    if (res && res.ok){
      toast('Deleted.', 'ok', 900);
    } else {
      toast('Delete failed. Reloading…', 'err', 1600);
      // Recover by reloading the range and re-rendering the active room
      await ensureRangeLoaded();
      renderRoom(activeRoom);
    }
    BUSY = false; editing = null;
  };

  saveBtn.onclick = async ()=>{
    if (BUSY) return;
    const name = nameEl.value.trim();
    const room = activeRoom; // locked to tab
    const hood = hoodEl.value;
    const date = dateEl.value;
    const sTime = startEl.value;
    const eTime = endEl.value;
  
    if (!name){ toast('Please enter your name.', 'warn'); return; }
    if (!date || !sTime || !eTime){ toast('Pick a date and start/end times.', 'warn'); return; }
  
    const start = buildDate(date, sTime);
    const end   = buildDate(date, eTime);
    const now   = new Date();
    const calendarId = `${room}-${hood}`;
    const title = titleFor(name, room, hood);
    if (end <= start){ toast('End time must be after start time.', 'warn'); return; }
    if (end - start < 15*60*1000){ toast('Minimum booking is 15 minutes.', 'warn'); return; }
    if (end <= now){ if(!confirm('This is in the past. Save anyway?')) return; }
  
    BUSY = true;
  
    // ---- EDIT EXISTING ----
    if (editing && editing.id){
      const id = editing.id;
  
      // Optimistic: close modal, update UI & cache first
      closeModal();
      Cal.update(id, calendarId, { title, start, end, calendarId });
      const ci = cache.events.findIndex(e => e.id === id);
      if (ci >= 0) cache.events[ci] = { id, calendarId, title, start: start.toISOString(), end: end.toISOString() };
  
      // Persist
      const resp = await postSimple({ action:'update', event:{ id, calendarId, title, start: start.toISOString(), end: end.toISOString() }});
      if (resp && resp.ok){
        toast('Saved.', 'ok', 900);
      } else {
        // Rollback on failure
        toast(resp && resp.error==='conflict' ? '⚠️ Conflict: that hood already has a booking.' : 'Update failed. Rolling back.', resp && resp.error==='conflict' ? 'warn' : 'err', 2000);
        await ensureRangeLoaded();
        renderRoom(activeRoom);
      }
      BUSY = false; editing = null; return;
    }
  
    // ---- CREATE NEW ----
    const id = uuid();
  
    // Optimistic: close modal, add to UI & cache first
    closeModal();
    Cal.add([{ id, calendarId, title, category:'time', start, end, isReadOnly:false }]);
    cache.events.push({ id, calendarId, title, start: start.toISOString(), end: end.toISOString() });
  
    // Persist
    const resp = await postSimple({ action:'create', event:{ id, calendarId, title, start: start.toISOString(), end: end.toISOString() }});
    if (resp && resp.ok){
      toast('Saved.', 'ok', 900);
    } else {
      // Rollback on failure
      toast(resp && resp.error==='conflict' ? '⚠️ Conflict: that hood already has a booking.' : 'Create failed. Rolling back.', resp && resp.error==='conflict' ? 'warn' : 'err', 2000);
      // Remove optimistic one and refresh
      const s = Cal.all().find(x => x.id === id);
      if (s) Cal.remove(id, s.calendarId);
      cache.events = cache.events.filter(e => e.id !== id);
      await ensureRangeLoaded();
      renderRoom(activeRoom);
    }
    BUSY = false; editing = null;
  };

  /* ---------- Init ---------- */
  setRangeTitle();
  (async ()=>{
    await ensureRangeLoaded();     // load once for visible range
    renderRoom(activeRoom);      // show the default room instantly
  })();
</script>
</body>
</html>

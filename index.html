<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riley Lab Portal</title>
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/RileyLab/RileyLab.github.io/master/favicon.ico" />

  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300..700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --muted:#495057;
      --text:#111;
      --accent:#0057b7;
      --ring:rgba(0,87,183,.25);
      --link:#0b5ed7;
      --warn-bg:#fff8e1;
      --warn-border:#ffe082;
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --shadow-hover:0 10px 26px rgba(0,87,183,.15);
      --radius:12px;
      --underline:linear-gradient(currentColor,currentColor);
    
      /* layout tuning */
      --page-max:1600px;
      --gap:22px;
      --left:460px;
      --ann-info:#2979ff;
      --ann-warn:#ffa000;
      --ann-urgent:#e53935;
    }
    
    /* -------------------------
       Base / page frame
       ------------------------- */
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    body::before{
      content:""; position:fixed; inset:0;
      background:url("https://raw.githubusercontent.com/RileyLab/RileyLab.github.io/master/fav-background.png") center/cover no-repeat fixed;
      z-index:-2; filter:saturate(.9) contrast(1.02);
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-1;
      background:rgba(245,247,251,.86); backdrop-filter:blur(.5px);
    }
    
    /* Page wrapper */
    .wrap{ max-width: var(--page-max); margin-inline:auto; padding:28px 20px 60px }
    
    /* Header */
    header{
      display:grid; grid-template-columns:1fr auto; align-items:end; gap:16px;
      margin:8px 0 16px;
    }
    .title{ font-size:clamp(24px,3.5vw,36px); font-weight:800; letter-spacing:.2px }
    .subtitle{ color:var(--muted); font-size:14px; margin-top:4px }
    
    /* Icon font */
    .ms{ font-family:"Material Symbols Rounded"; font-weight:400; font-style:normal; font-size:20px; line-height:1 }
    
    /* -------------------------
       Notices / toast
       ------------------------- */
    .notice{
      display:none; align-items:center; gap:10px;
      background:var(--warn-bg); border:1px dashed var(--warn-border);
      color:#3b3b00; padding:10px 12px; border-radius:var(--radius); margin:0 0 16px;
    }
    .notice.show{ display:flex }
    .notice .close{ margin-left:auto; background:transparent; border:0; cursor:pointer; font-size:18px; line-height:1; color:#6c6c3a }
    
    .notice-fixed{
      position:fixed; top:20px; right:20px; width:280px; z-index:9999;
      background:#fff8e1; border:2px solid #ffca28; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.15);
      padding:14px 16px; display:flex; align-items:flex-start; gap:10px; color:#3b3b00; font-weight:600; font-size:14px;
      opacity:0; transform:translateX(100%); transition:transform .5s ease, opacity .6s ease;
    }
    .notice-fixed.show{ opacity:1; transform:translateX(0); animation:pulseNotice 3s infinite }
    @keyframes pulseNotice{
      0%,100%{ box-shadow:0 0 0 0 rgba(255,193,7,.4) }
      50%{ box-shadow:0 0 0 6px rgba(255,193,7,0) }
    }
    .notice-fixed .ms{ font-size:22px; color:#ff8f00; flex-shrink:0 }
    
    /* -------------------------
       Search / actions
       ------------------------- */
    .actions{ display:flex; gap:10px; align-items:center }
    .pill{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid #ddd; color:var(--muted) }
    .search{
      display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #dfe6ef;
      border-radius:999px; padding:8px 12px; box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    .search input{ border:0; outline:0; font:inherit; background:transparent; min-width:300px }
    .search:focus-within{ box-shadow:0 0 0 3px var(--ring) }
    
    /* -------------------------
       Layout: sidebars / grid
       ------------------------- */
    .layout{
      display: grid; gap: var(--gap);
      grid-template-columns: var(--left) 1fr;
      align-items:start;
    }
    @media (max-width:1250px){
      :root{ --left:420px; --page-max:1500px; }
      .layout{ grid-template-columns:320px 1fr; }
      .rightbar{ grid-column:1 / -1; }
    }
    @media (max-width:1000px){
      .layout{ grid-template-columns:1fr; }
      .sidebar .card{ position: static; top:auto; }
    }
    
    /* Sidebars stickiness */
    .sidebar .card, .rightbar .card{ position:sticky; top:16px }
    
    /* Main center grid */
    .grid{
      display:grid; gap: var(--gap);
      grid-template-columns: repeat(3, minmax(300px, 1fr));
    }
    @media (max-width:1250px){
      .grid{ grid-template-columns: repeat(2, minmax(320px, 1fr)); }
    }
    @media (max-width:900px){
      .grid{ grid-template-columns:1fr }
    }
    
    /* -------------------------
       Cards
       ------------------------- */
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px; border:1px solid #e7e7e7; position:relative;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{ transform:translateY(-3px); box-shadow:var(--shadow-hover); border-color:#d6e3ff }
    @media (prefers-reduced-motion:reduce){
      .card{ transition:box-shadow .18s ease, border-color .18s ease }
      .card:hover{ transform:none }
    }
    .card h2{
      font-size:20px; letter-spacing:.3px; margin:-18px -18px 12px -18px; padding:14px 18px;
      border-radius:var(--radius) var(--radius) 0 0; color:#222; display:flex; align-items:center; gap:10px;
      box-shadow:inset 0 -1px 0 rgba(0,0,0,.08);
    }
    .card h2 .badge{ margin-left:auto }
    .badge{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:3px 10px; border-radius:999px; background:#eef4ff; color:#143d8d; border:1px solid #d5e3ff }
    
    /* -------------------------
       Lists & links
       ------------------------- */
    .list{ list-style:none; padding:0; margin:0 }
    .list li{ margin:8px 0 }
    .link{
      text-decoration:none; color:var(--link); font-weight:600; position:relative;
      display:inline-flex; align-items:center; gap:10px; padding:6px 10px;
      border-radius:8px; outline:none; border:1px solid transparent; transition:background .15s ease, border-color .15s ease;
    }
    .link::after{
      content:""; position:absolute; left:10px; right:10px; bottom:6px; height:2px;
      background:var(--underline); transform:scaleX(0); transform-origin:left; transition:transform .2s ease; opacity:.75;
    }
    .link:hover{ background:#eaf2ff; border-color:#cfe0ff }
    .link:hover::after{ transform:scaleX(1) }
    .link:focus{ box-shadow:0 0 0 3px var(--ring) }
    .ext::after{ content:none !important }
    .muted{ color:var(--muted); font-weight:500 }
    
    /* -------------------------
       Details / disclosure
       ------------------------- */
    details{ border:1px solid #ddd; border-radius:8px; padding:10px 12px; background:#fafafa }
    details[open]{ background:#e3f2fd }
    summary{
      cursor:pointer; list-style:none; font-weight:700; display:flex; align-items:center; gap:8px; position:relative; padding-left:20px;
    }
    summary::before{
      content:""; position:absolute; left:0; top:50%; transform:translateY(-50%) rotate(0);
      border-width:5px 0 5px 7px; border-style:solid; border-color:transparent transparent transparent #555; transition:transform .2s ease;
    }
    details[open] > summary::before{ transform:translateY(-50%) rotate(90deg) }
    summary .ms{ font-size:20px; line-height:1; position:relative; top:1px }
    summary::-webkit-details-marker{ display:none }
    
    /* -------------------------
       Calendar
       ------------------------- */
    #live-cal-title{ background:#cfe0ff }
    .iframe-wrap{
      border:1px solid #e0e7ef; border-radius:10px; overflow:hidden; box-shadow:var(--shadow); background:#fff;
      display:flex; flex-direction:column;
    }
    .iframe-wrap iframe{ width:100%; height:100%; border:0 }
    .sidebar .card#live-cal-card { display:flex; flex-direction:column; min-height:720px; max-height:1000px; height:100%; }
    #iframe-wrap { flex:1; }
    .calendar-toolbar{
      display:flex; gap:8px; align-items:center; margin:10px 0 12px;
    }
    .calendar-toolbar .btn{
      appearance:none; border:1px solid #d6e3ff; background:#f4f8ff; color:#0b3d91;
      padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .calendar-toolbar .btn[aria-pressed="true"]{ background:#e6efff; border-color:#bcd0ff }
    
    /* calendar toggle colored buttons */
    .calendar-toolbar .btn[data-cal] { border: none; border-radius: 8px; padding: 6px 14px; margin-left: 6px; font-weight: 600; color: white; cursor: pointer; transition: all .25s ease; }
    .calendar-toolbar .btn[data-cal="MAIN"] { background-color: #d32f2f; }
    .calendar-toolbar .btn[data-cal="MAIN"]:hover { background-color: #b71c1c; }
    .calendar-toolbar .btn[data-cal="293T"] { background-color: #fbc02d; color: #333; }
    .calendar-toolbar .btn[data-cal="293T"]:hover { background-color: #f9a825; }
    .calendar-toolbar .btn[data-cal][aria-pressed="true"] { box-shadow: 0 0 10px rgba(0,0,0,0.25); transform: scale(1.05); }
    
    /* -------------------------
       Announcements
       ------------------------- */
    .ann-banner.card { padding: 12px 14px; margin-bottom: 12px; }
    #ann-banner-title{ background:#ffe3b3; }
    .ann-list { gap: 10px; }
    
    /* announcement card */
    .ann-banner .ann-list li,
    .ann-item {
      background: #fffaf0;                /* warm pale background */
      border: 1px solid #f4e1b8;         /* soft yellow border */
      border-radius: 10px;               /* rounded corners like screenshot */
      padding: 10px 12px;                /* slightly roomier interior */
      box-shadow: 0 4px 12px rgba(0,0,0,0.04); /* softer shadow */
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .ann-item.info   { border-left-color: var(--ann-info); }
    .ann-item.warn   { border-left-color: var(--ann-warn); }
    .ann-item.urgent { border-left-color: var(--ann-urgent); }
    
    .ann-item.new{ animation:annPop .35s ease-out; }
    @keyframes annPop{ 0%{transform:scale(.96); opacity:0} 100%{transform:scale(1); opacity:1} }
    
    .ann-chip{ grid-row:1 / span 2; align-self:start; display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:10px; font-weight:800; color:#fff; }
    .ann-chip.info   { background:#2979ff; }
    .ann-chip.warn   { background:#ffa000; }
    .ann-chip.urgent { background:#e53935; }
    
    .ann-head{ display:flex; gap:8px; align-items:center; font-weight:800; color:#1c2430; }
    .ann-head::before { content: ""; width:8px; height:8px; border-radius:50%; flex:0 0 8px; background: currentColor; }
    
    /* Stronger badge look, with color variants that mirror the left stripe */
    .ann-time {
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid transparent;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      white-space:nowrap;
    }
    
    /* Per-level color treatments (use the same colors as border-left) */
    .ann-item.info   .ann-time { background: #eef4ff; color: #143d8d; border-color: #d5e3ff; }
    .ann-item.warn   .ann-time { background: #fff7ea; color: #b35b00; border-color: #ffddb3; }
    .ann-item.urgent .ann-time { background: #ffecec; color: #a41616; border-color: #ffb3b3; }
    
    /* add a tiny calendar glyph before the date */
    .ann-time::before {
      content: "ðŸ—“";
      display:inline-block;
      transform: translateY(1px);
      font-size:13px;
      margin-right:4px;
      opacity:0.95;
    }
    .ann-body{ color:#263238; line-height:1.45; position:relative; }
    .ann-actions{ display:flex; gap:8px; margin-top:8px; }
    .ann-actions .btn-min{
      appearance:none; border:1px solid #dfe6ef; background:#f7faff; padding:4px 8px; border-radius:8px;
      font-size:12px; font-weight:700; color:#0b3d91; cursor:pointer;
    }
    
    /* NEW pill */
    .badge-new{
      margin-left:auto; font-size:11px; font-weight:900; color:#b71c1c; background:#ffebee; border:1px solid #ffcdd2;
      padding:2px 8px; border-radius:999px; display:none;
    }
    .ann-item.new .badge-new{ display:inline-flex; }
    
    /* toolbar actions (header-level) */
    .ann-toolbar{ display:flex; align-items:center; gap:8px; margin-top:8px; }
    .ann-toolbar .pill-action{ margin-left:auto; font-size:12px; padding:5px 10px; border-radius:999px; border:1px solid #d6e3ff; background:#eef4ff; color:#0b3d91; font-weight:800; cursor:pointer; }
    
    /* mark-read fade */
    .ann-item.read .btn-min { opacity: 0; transform: scale(0.9); pointer-events: none; transition: all 0.3s ease; }
    
    /* compact/alternate sizes */
    .card.ann-banner, .card.room-rot { padding:10px 12px; }
    .card.ann-banner h2, .card.room-rot h2 { padding:8px 12px; font-size:16px; }
    
    /* clamp long bodies to reduce height */
    .ann-body.clamp {
      display: -webkit-box;
      -webkit-line-clamp: 6; /* visible lines before "More" */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .ann-body.clamp::after {
      content: "";
      position: absolute;
      inset: auto 0 0 0;
      height: 2.2em;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff);
      pointer-events: none;
    }
    
    /* More / Less */
    .ann-more {
      appearance: none;
      border: 1px solid #dfe6ef;
      background: #f7faff;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #0b3d91;
      cursor: pointer;
    }
    .ann-item.expanded .ann-body.clamp { -webkit-line-clamp: unset; overflow: visible; }
    .ann-item.expanded .ann-body.clamp::after { display: none; }
    
    /* -------------------------
       Rotations / Room maintenance
       ------------------------- */
    .card.room-rot { display:block; max-width:var(--page-max); margin:16px auto 28px; }
    .room-rot #rot-title { background:#e6efff; }
    .rot-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; }
    .rot-col{ border:1px solid #e2e6ee; border-radius:10px; overflow:hidden; background:#fff; box-shadow:var(--shadow); }
    .rot-h{ font-weight:800; color:#111; text-align:center; padding:8px 10px; border-bottom:1px solid rgba(0,0,0,.08); font-size:18px; }
    .rot-body{ padding:10px 12px; text-align:center; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    
    /* rotation date range badge */
    #rot-dates {
      display:inline-flex; align-items:center; gap:8px;
      background:#eef4ff; color:#1a1f36; font-weight:600; font-size:15px; border-radius:8px;
      padding:6px 12px; border:1px solid #d0daee; box-shadow:0 2px 6px rgba(0,0,0,0.05); margin-bottom:10px;
    }
    #rot-dates:hover { background:#e1ecff; border-color:#c2d5ff; box-shadow:0 3px 8px rgba(0,0,0,0.08); }
    #rot-dates .ms { font-size:18px; color:#4a6fd6; line-height:1; position:relative; top:1px; }
    
    /* rotation palette (header backgrounds) */
    .rot-tc1 { background:#f8bf20; }   /* amber */
    .rot-tc2 { background:#5a84e8; color:#fff; }
    .rot-tc3 { background:#74b65a; color:#0f2a0f; }
    .rot-main{ background:#d32f2f; color:#fff; }
    
    /* rotation editor */
    .rot-edit{ margin-top:12px; border:1px dashed #d8e1ff; border-radius:10px; padding:10px 12px; background:#f8fbff; display:none; }
    .rot-edit[open]{ background:#eef5ff; }
    body.admin .rot-edit { display:block; }
    
    .rot-form{ display:grid; gap:12px; }
    .rot-form .row{ display:grid; gap:10px; grid-template-columns: repeat(4, minmax(0,1fr)); }
    .rot-form label{ display:flex; flex-direction:column; gap:6px; font-weight:700; font-size:14px; }
    .rot-form input{ border:1px solid #dfe6ef; border-radius:8px; padding:8px 10px; font:inherit; background:#fff; }
    .rot-form input:focus{ outline:none; box-shadow:0 0 0 3px var(--ring); }
    .rot-form .actions{ display:flex; gap:10px; align-items:center; }
    .btn-primary{ appearance:none; border:1px solid #bcd0ff; background:#e6efff; color:#0b3d91; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-ghost{ appearance:none; border:1px solid #e0e7ef; background:#fff; color:#333; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; }
    .hint{ font-size:12px; color:#6b7280; }
    .room-rot .rot-form input:disabled { background:#f4f6fa; color:#7a869a; cursor:not-allowed; }
    
    /* -------------------------
       Notes dock / editor
       ------------------------- */
    .notes-dock {
      position: fixed; top:120px; width:260px; max-height:calc(100vh - 160px);
      display:flex; flex-direction:column; gap:10px; z-index:999; pointer-events:none;
    }
    .note-card {
      pointer-events:auto; background:#fffbe7; border:1px solid #e8dfb0; box-shadow:0 6px 18px rgba(0,0,0,.08);
      border-radius:12px; padding:42px 12px 40px 12px; position:relative;
    }
    .note-card .note-toolbar{ position:absolute; right:8px; top:8px; display:flex; gap:6px; z-index:2; background: rgba(255, 251, 231, 0.85); border-radius:8px; padding:2px; }
    .note-btn{ appearance:none; border:1px solid #ddd4a4; background:#fff7c6; font-size:12px; padding:2px 6px; border-radius:8px; cursor:pointer; }
    .note-btn:hover { background:#fff1a1; }
    .note-textarea{ width:100%; min-height:90px; border:none; resize:vertical; background:transparent; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#3d3a2a; outline:none; display:block; box-sizing:border-box; }
    .btn-note{ appearance:none; border:1px solid #cfd8ea; background:#eaf2ff; color:#0b3d91; font-weight:700; border-radius:10px; padding:8px 12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .btn-note:hover{ background:#dce9ff; }
    .btn-note[disabled]{ opacity:.5; cursor:not-allowed; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(2px)} 75%{transform:translateX(-2px)} }
    .btn-note.shake { animation: shake .25s ease-in-out; }
    
    /* -------------------------
       Utility / small tweaks
       ------------------------- */
    .footer{ margin-top:26px; color:var(--muted); font-size:12px }
    .stack{ display:flex; gap:8px; flex-wrap:wrap }
    
    /* spacing tweaks */
    .card.ann-banner { margin: 0 0 12px; }
    .card.room-rot { margin: 12px auto 16px; }
    
    /* -------------------------
       Responsive adjustments
       ------------------------- */
    @media (max-width: 1540px){
      .grid{ grid-template-columns: repeat(2, minmax(340px, 1fr)); }
    }
    @media (max-width: 1000px){
      .layout{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .sidebar .card{ position: static; top:auto; }
    }
    @media (max-width: 900px){
      .rot-form .row{ grid-template-columns: 1fr 1fr; }
      .iframe-wrap iframe{ height:520px; }
    }
    @media (max-width: 768px){
      .grid{ grid-template-columns: 1fr; }
      .iframe-wrap iframe{ height:600px; }
    }
    @media (max-width: 480px){
      .wrap{ padding:16px 12px 40px; }
      header{ grid-template-columns: 1fr; align-items: start; gap: 8px; }
      .title{ font-size:22px; line-height:1.15; }
      .subtitle{ font-size:12px; }
      .actions{ width:100%; gap:8px; }
      .search{ width:100%; }
      .search input{ min-width:0; width:100%; }
      .card{ padding:14px; }
      .card h2{ font-size:18px; padding:12px 14px; }
      .badge{ font-size:11px; padding:2px 8px; }
      .rot-grid{ grid-template-columns: repeat(2, 1fr); gap:6px; }
      .rot-h{ font-size:13px; padding:6px 8px; }
      .rot-body{ padding:8px 10px; }
      .calendar-toolbar{ gap:6px; margin:8px 0 10px; }
      .calendar-toolbar .btn{ padding:4px 8px; font-size:13px; }
      .iframe-wrap iframe{ height:520px; }
      .ann-banner .ann-list{ grid-template-columns: 1fr; }
      #admin-toggle{ right:10px; bottom:10px; font-size:11px; padding:4px 6px; }
    }
    @media (max-width: 980px){
      .notes-dock, #add-note-fab { display:none; }
    }

    /* ==========================
   Restore colored card headers
   Targets: cal / equip / cores / duties / tools / misc
   Paste this at the END of your stylesheet.
   ========================== */

  #cal-title,
  #equip-title,
  #cores-title,
  #duties-title,
  #tools-title,
  #misc-title {
    color: #111;
    font-weight: 800;
    padding: 10px 16px;
    border-radius: var(--radius) var(--radius) 0 0;
    box-shadow: inset 0 -1px 0 rgba(0,0,0,0.04);
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  
  /* Stronger, saturated header backgrounds + readable text color */
  #cal-title      { background: #cfe0ff; color: #0b3d91; } /* Calendar / Fortessa top */
  #equip-title    { background: #cfe8ff; color: #08306b; } /* Shared Use Equipment */
  #cores-title    { background: #e6f5ea; color: #155724; } /* UPenn Cores (green) */
  #duties-title   { background: #fff4e0; color: #8a5200; } /* Lab Duties (warm) */
  #tools-title    { background: #eaf7ff; color: #0b5ed7; } /* Tools & Docs (blue) */
  #misc-title     { background: #fff0f2; color: #8b1f1f; } /* Other Resources (rose) */
  
  /* Make the small .badge inside the h2 visually match the header */
  #cal-title .badge      { background: #d9e9ff; color: #0b3d91; border: 1px solid rgba(11,61,145,0.06); }
  #equip-title .badge    { background: #e6f0ff; color: #08306b; border: 1px solid rgba(8,48,107,0.06); }
  #cores-title .badge    { background: #eaf9ec; color: #155724; border: 1px solid rgba(21,87,36,0.06); }
  #duties-title .badge   { background: #fff6e6; color: #8a5200; border: 1px solid rgba(138,82,0,0.06); }
  #tools-title .badge    { background: #f0fbff; color: #0b5ed7; border: 1px solid rgba(11,94,215,0.06); }
  #misc-title .badge     { background: #fff3f4; color: #8b1f1f; border: 1px solid rgba(139,31,31,0.06); }
  
  /* Badge styling: keep it compact and bold */
  .card h2 .badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 4px 8px;
    border-radius: 999px;
    font-weight: 800;
    font-size: 12px;
    box-shadow: none;
  }
  
  /* Keep card body white and with a subtle shadow so header color pops */
  .card {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    overflow: visible;
  }
  
  /* Small polish: make the header bleed naturally into rounded card */
  .card > h2 {
    margin: -10px -10px 12px -10px;
    padding-left: 18px;
    padding-right: 18px;
  }
  
  /* Fallback selector: if some cards don't use these IDs, target by text (less ideal)
     Uncomment only if needed:
  .card h2:has(.ms + text("Fortessa/Hood Bookings")) { background: #cfe0ff; }
  */
  
  /* Responsive tweak: slightly reduce padding on very small screens */
  @media (max-width: 480px) {
    #cal-title,
    #equip-title,
    #cores-title,
    #duties-title,
    #tools-title,
    #misc-title { padding: 8px 10px; font-size: 15px; }
    .card h2 .badge { padding: 3px 6px; font-size: 11px; }
  }

    
  </style>

</head>
<body>
<div class="wrap">

  <!-- Live Notice Banner -->
  <div id="notice" class="notice notice-fixed" role="status" aria-live="polite">
    <span class="ms" aria-hidden="true">campaign</span>
    <div id="notice-text">Loadingâ€¦</div>
  </div>

  <header>
    <div>
      <div class="title">Riley Lab Portal</div>
      <div class="subtitle">Riley Lab essentials all in one place</div>
    </div>

    <div class="actions">
      <div class="search" role="search">
        <span class="ms" aria-hidden="true">search</span>
        <input id="q" type="search" placeholder="Quick find linksâ€¦" aria-label="Search links">
      </div>
      
      <span class="pill">Updated</span>
      <span class="pill">v1.1</span>
    </div>
  </header>

<section class="card ann-banner" aria-labelledby="ann-banner-title">
  <h2 id="ann-banner-title">
    <span class="ms" aria-hidden="true" style="font-size:2em;">campaign</span>
    LAB ANNOUNCEMENTS
    <span id="ann-header-dot" class="dot" aria-hidden="true"></span>
  </h2>
  <ul id="ann-banner-list" class="list ann-list"></ul>
</section>

<section class="card room-rot" id="rotations-card" aria-labelledby="rot-title">
  <h2 id="rot-title">
    <span class="ms" aria-hidden="true">cleaning_services</span>
    Room Maintenance Rotations
    <span class="badge" id="rot-dates"></span>
  </h2>

  <!-- Display grid -->
  <div class="rot-grid" id="rot-grid">
    <!-- Filled by JS -->
  </div>

  <!-- Inline editor (collapsible) -->
  <details class="rot-edit" id="rot-edit">
    <summary><span class="ms" aria-hidden="true">edit</span> Update assignments</summary>

    <form id="rot-form" class="rot-form">
      <div class="row">
        <label>
          Start
          <input type="date" name="start" required>
        </label>
        <label>
          End
          <input type="date" name="end" required>
        </label>
      </div>

      <div class="row">
        <label>TC1 <input type="text" name="tc1" placeholder="Name"></label>
        <label>TC2 <input type="text" name="tc2" placeholder="Name"></label>
        <label>TC3 <input type="text" name="tc3" placeholder="Name"></label>
        <label>Main Lab <input type="text" name="main" placeholder="Name"></label>
      </div>

      <div class="actions">
        <button type="submit" class="btn-primary"><span class="ms" aria-hidden="true">save</span> Save</button>
        <button type="button" id="rot-clear" class="btn-ghost"><span class="ms" aria-hidden="true">restart_alt</span> Clear</button>
      </div>
      <div class="hint">Tip: updates are saved in your browser (localStorage).</div>
    </form>
  </details>
</section>
  
<div class="layout">
  <!-- LEFT: sidebar calendar -->
  <aside class="sidebar" aria-label="Lab calendar">
    <section class="card" id="live-cal-card" aria-labelledby="live-cal-title">
      <h2 id="live-cal-title"><span class="ms" aria-hidden="true">calendar_month</span> Riley Lab Calendar</h2>

      <div class="calendar-toolbar" role="toolbar" aria-label="Calendar view">
        <button class="btn" data-cal="MAIN" aria-pressed="true">MAIN</button>
        <button class="btn" data-cal="293T" aria-pressed="true">293T</button>

        <span style="margin:0 6px;opacity:.5">|</span>
        
        <button class="btn" data-mode="AGENDA" aria-pressed="false">Agenda</button>
        <button class="btn" data-mode="WEEK"   aria-pressed="false">Week</button>
        <button class="btn" data-mode="MONTH"  aria-pressed="true">Month</button>
      </div>
      
      <div class="iframe-wrap" style="margin-top:10px">
        <iframe
          title="Riley Lab Google Calendar"
          loading="lazy"
          src="https://calendar.google.com/calendar/embed?src=j27deqargjjbeg5835162djbl8%40group.calendar.google.com&ctz=America%2FNew_York&mode=MONTH&showPrint=0&showTabs=0&showCalendars=0&showTitle=0&showTz=0&wkst=1&bgcolor=%23ffffff">
        </iframe>
      </div>

      <div class="stack" style="margin-top:10px">
        <a class="link ext" href="https://calendar.google.com/calendar/embed?src=j27deqargjjbeg5835162djbl8%40group.calendar.google.com&ctz=America%2FNew_York" target="_blank" rel="noopener">
          <span class="ms" aria-hidden="true">open_in_new</span> Main Calendar (VIEW ONLY)
        </a>

        <a class="link ext" href="https://calendar.google.com/calendar/embed?src=0192dc1394d85223a6c361fc1a8875ab5db51d465c28fffafb6d7abe9d9e8e0d@group.calendar.google.com&ctz=America%2FNew_York" target="_blank" rel="noopener">
          <span class="ms" aria-hidden="true">open_in_new</span> 293T Calendar (VIEW ONLY)
        </a>
      </div>
    </section>
  </aside>

  <main class="grid" aria-label="Link groups">

    <section class="card" id="card-calendars-hood" aria-labelledby="...">
      <h2 id="cal-title"><span class="ms" aria-hidden="true">event</span> Fortessa/Hood Bookings <span class="badge"><span class="ms" aria-hidden="true">calendar_month</span>Bookings</span></h2>
      <ul class="list" style="margin-top:10px">
        <!-- <li><a class="link ext" href="https://www.brownbearsw.com/cal/RNAFortessa" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">schedule</span> Fortessa <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li> -->
        <li><a class="link ext" href="https://pathbio.med.upenn.edu/flow/shiner/Calendars/home" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">waterfall_chart</span> General Flow Core Scheduler <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://pathbio.med.upenn.edu/flow/shiner/Calendars/instrument/41?researcher=11539692&date=2025-10-24" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">waterfall_chart</span> Riley Lab Fortessa Scheduler <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
      </ul>
      <details>
        <summary><span class="ms" aria-hidden="true">lab_profile</span> Riley Lab Hood Bookings</summary>
        <ul class="list" aria-label="Riley Lab Hood Bookings list">
          <li><a class="link ext" href="https://www.brownbearsw.com/cal/HIVRoom" target="_blank" rel="noopener">TC1 <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
          <li><a class="link ext" href="https://www.brownbearsw.com/cal/CancerRoom" target="_blank" rel="noopener">TC2 <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
          <li><a class="link ext" href="https://www.brownbearsw.com/cal/translationalroom" target="_blank" rel="noopener">TC3 <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        </ul>
      </details>
    </section>

    <section class="card" aria-labelledby="equip-title">
      <h2 id="equip-title"><span class="ms" aria-hidden="true">biotech</span> Shared Use Equipment <span class="badge"><span class="ms" aria-hidden="true">group</span>Shared</span></h2>
      <ul class="list">
        <li><a class="link ext" href="https://med-upenn.corefacilities.org/service_center/show_external/5381/small_animal_radiation_core_sarc" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">radiology</span> Irradiator <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://med-upenn.corefacilities.org/sc/6469/i3h-service-center?tab=equipment" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">science</span> 3600 CCB Ultra Centrifuge <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://teamup.com/kssvtmecq8agaw4phy" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">monitor_heart</span> xCELLigence <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <!-- <li><a class="link ext" href="https://pathbio.med.upenn.edu/flow/shiner/Calendars/home" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">waterfall_chart</span> Fortessa Flow Core Scheduler <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li> -->
      </ul>
    </section>

    <section class="card" aria-labelledby="duties-title">
      <h2 id="duties-title"><span class="ms" aria-hidden="true">assignment_turned_in</span> Lab Duties <span class="badge"><span class="ms" aria-hidden="true">change_circle</span>Rotations</span></h2>
      <ul class="list">
        <li><a class="link ext" href="Czardoms.html" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">inventory</span> Czardoms <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <!-- <li><a class="link ext" href="https://www.brownbearsw.com/cal/293T" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">coronavirus</span> 293T Cells <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li> -->
        <li><a class="link ext" href="sidebyside293T.html" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">assignment_add</span> 293T Request Form <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://calendar.google.com/calendar/u/2?cid=MDE5MmRjMTM5NGQ4NTIyM2E2YzM2MWZjMWE4ODc1YWI1ZGI1MWQ0NjVjMjhmZmZhZmI2ZDdhYmU5ZDllOGUwZEBncm91cC5jYWxlbmRhci5nb29nbGUuY29t" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">coronavirus</span> 293T Calendar <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
      </ul>
      <details>
        <summary><span class="ms" aria-hidden="true">cleaning_services</span> Room Maintenance Rotations</summary>
        <ul class="list" aria-label="Riley Lab Hood Bookings list">
          <li><a class="link ext" href="https://www.brownbearsw.com/mc/Riley/TC1Restocking" target="_blank" rel="noopener">TC1 Duty <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
          <li><a class="link ext" href="https://www.brownbearsw.com/mc/Riley/TC2Restocking" target="_blank" rel="noopener">TC2 Duty <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
          <li><a class="link ext" href="https://www.brownbearsw.com/mc/Riley/TC3Restocking" target="_blank" rel="noopener">TC3 Duty <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
          <li><a class="link ext" href="https://www.brownbearsw.com/mc/Riley/mainlabduty" target="_blank" rel="noopener">Main Lab Duty <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        </ul>
      </details>
    </section>

    <section class="card" id="card-upenn-cores" aria-labelledby="cores-title">
      <h2 id="cores-title"><span class="ms" aria-hidden="true">hub</span> UPenn Cores <span class="badge"><span class="ms" aria-hidden="true">category</span>Cores</span></h2>
      <ul class="list">
        <li><a class="link ext" href="https://www.med.upenn.edu/apps/my/index.php?_app_id=5ecffaaf109d6&_display=1&_hist_id=1&_preserve[init_panel]=dnacore%2Fmain&_token=5fb240a6e9f15f8adf144d9632c2fc81&CEALID=6B037AA7C0FFD4D899C03C18B4E98342&_token=3adca2be899805c397f63c7bf0dbfdb8" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">genetics</span> Penn Sequencing Core <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://pathbio.med.upenn.edu/hic/hiccell/" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">bloodtype</span> HIC Cell Ordering <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://pathbio.med.upenn.edu/duars/EntreeServer/" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">analytics</span> Flow Core Data <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://pathbio.med.upenn.edu/saif/EntreeServer/" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">pets</span> Mouse Imaging Data <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://genetics.med.upenn.edu/cores/cell-center-stockroom/" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">inventory_2</span> Cell Center Stockroom <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://med-upenn.corefacilities.org/homepage/" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">lab_research</span> iLab (Xenograft Core) <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
      </ul>
    </section>

    <section class="card" aria-labelledby="tools-title">
      <h2 id="tools-title"><span class="ms" aria-hidden="true">construction</span> Tools & Docs <span class="badge"><span class="ms" aria-hidden="true">star</span>Essentials</span></h2>
      <ul class="list">
        <li><a class="link ext" href="https://forms.gle/mNc43ejEpeXRTfYV9" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">assignment_add</span> Riley Lab Ordering Form <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://docs.google.com/spreadsheets/d/1EWxp0SgVXKpk8jPVvy0lLlk8iD1QHOZ_Ocj8JSMj218/edit?usp=sharing" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">table_chart</span> Order Statuses (Google Sheet) <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://penno365-my.sharepoint.com/:o:/g/personal/rileyj_upenn_edu/EreHrOPLVsBMhp_VD8rdvDwBXswkXTZpRWzQqIWqfsGnzA?e=08zM26" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">book_4</span> Riley Lab OneNote <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://lims.pmacs.upenn.edu/limsprod/logon.jsp" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">dns</span> LabVantage <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://upenn.app.box.com/file/878046376947" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">inventory</span> Plasmid &amp; Bacterial Stock List.xls <span class="muted">(Box)</span> <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://upenn.app.box.com/folder/132773147650" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">folder_zip</span> Plasmid DNA SnapGene Files <span class="muted">(Box)</span> <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
      </ul>
    </section>

    <section class="card" aria-labelledby="misc-title">
      <h2 id="misc-title"><span class="ms" aria-hidden="true">link</span> Other Resources <span class="badge"><span class="ms" aria-hidden="true">handyman</span>Handy</span></h2>
      <ul class="list">
        <li><a class="link ext" href="http://apps.brownbearsw.com/iobee/FlowJo" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">key</span> FlowJo Dongles <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://rileylabworkspace.slack.com/" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">chat</span> Riley Lab Slack <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://app.quartzy.com/groups/201349/requests?status" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">shopping_cart</span> Riley Lab Quartzy <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://calendar.med.upenn.edu/cci/secure/mrbs/index.php" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">speed</span> Smilow Ultra Centrifuge <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
        <li><a class="link ext" href="https://helpdesk.pmacs.upenn.edu/userui/ticket_list.php?DEFAULT=1&QUEUE_ID=63" target="_blank" rel="noopener"><span class="ms" aria-hidden="true">help_outline</span> I3H Helpdesk <span class="ms arrow" aria-hidden="true">arrow_outward</span></a></li>
      </ul>
    </section>

  </main>

  <footer>
    <div>Riley Labâ„¢</div>
    <div>Updated and maintained by Max Eldabbas</div>
  </footer>
</div>

<!-- <a id="admin-toggle" href="/admin" title="Open Admin">Admin</a> -->

<!-- Sticky Notes -->
<div id="notes-dock" class="notes-dock" aria-label="Personal sticky notes"></div>
<!-- <button id="add-note-fab" type="button" title="Add sticky note">+ Add Note</button> -->

<script>

/* === HELPERS === */
// Parse a YYYY-MM-DD as a *local* date (no UTC shift)
function parseYMDLocal(s) {
  if (typeof s !== 'string') return null;
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  const y = +m[1], mm = +m[2] - 1, d = +m[3];
  return new Date(y, mm, d); // local midnight
}

// Keep the input value stable (donâ€™t round-trip through Date unless needed)
function toInputDateString(dLike) {
  if (typeof dLike === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dLike)) return dLike;
  if (!(dLike instanceof Date)) return '';
  const y = dLike.getFullYear();
  const m = String(dLike.getMonth() + 1).padStart(2, '0');
  const d = String(dLike.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

// Nice badge text from a YYYY-MM-DD (local)
function badgeDateYMD(s) {
  const d = parseYMDLocal(s);
  return d ? d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) : '';
}

// Returns "today" at local midnight. Can be overridden via URL ?asof=YYYY-MM-DD
// or localStorage.debugDate = "YYYY-MM-DD"
function getTodayLocal() {
  const qs = new URLSearchParams(location.search);
  const fromQS = qs.get('asof');
  const fromLS = localStorage.getItem('debugDate');

  const val = fromQS || fromLS;
  if (val && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
    const d = parseYMDLocal(val);
    if (d) return d;
  }
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate());
}

function insertAtCursor(ta, text){
  const { selectionStart: s, selectionEnd: e, value } = ta;
  ta.value = value.slice(0, s) + text + value.slice(e);
  const pos = s + text.length;
  ta.setSelectionRange(pos, pos);
  ta.dispatchEvent(new Event('input'));
}

function lineRangeAtCursor(ta){
  const { value, selectionStart: i } = ta;
  let a = value.lastIndexOf('\n', i - 1) + 1; // start of line
  let b = value.indexOf('\n', i);
  if (b === -1) b = value.length;            // end of last line
  return [a, b];
}

function addPrefixAtLine(ta, prefix){
  const [a, b] = lineRangeAtCursor(ta);
  const before = ta.value.slice(0, a);
  const line   = ta.value.slice(a, b);
  const after  = ta.value.slice(b);
  if (!line.startsWith(prefix)) {
    const caret = ta.selectionStart + prefix.length;
    ta.value = before + prefix + line + after;
    ta.setSelectionRange(caret, caret);
    ta.dispatchEvent(new Event('input'));
  }
}

function currentLinePrefix(ta){
  const [a, b] = lineRangeAtCursor(ta);
  const line = ta.value.slice(a, b);
  // support bullets "â€¢ " or "- " and checklists "- [ ] " or "- [x] "
  const m = line.match(/^(\s*(?:â€¢ |\- |\-\s\[\s\]\s|\-\s\[x\]\s))/i);
  return m ? m[1] : '';
}

function toggleCheckboxAtLine(ta){
  const [a, b] = lineRangeAtCursor(ta);
  const before = ta.value.slice(0, a);
  let line     = ta.value.slice(a, b);
  const after  = ta.value.slice(b);

  if (/^- \[\s\] /i.test(line)) {
    line = line.replace(/^- \[\s\] /i, '- [x] ');
  } else if (/^- \[x\] /i.test(line)) {
    line = line.replace(/^- \[x\] /i, '- [ ] ');
  } else {
    // if not a checklist line yet, make it one
    line = '- [ ] ' + line.replace(/^\s*/, '');
  }
  const caretOffset = (before + line).length;
  ta.value = before + line + after;
  ta.setSelectionRange(caretOffset, caretOffset);
  ta.dispatchEvent(new Event('input'));
}

function wrapSelection(ta, before, after){
  const start = ta.selectionStart;
  const end = ta.selectionEnd;
  const value = ta.value;
  const sel = value.slice(start, end);

  const isWrapped = sel.startsWith(before) && sel.endsWith(after);

  let newText;
  if (isWrapped) {
    // remove wrapping
    newText = sel.slice(before.length, sel.length - after.length);
    ta.value = value.slice(0, start) + newText + value.slice(end);
    ta.setSelectionRange(start, start + newText.length);
  } else {
    newText = before + sel + after;
    ta.value = value.slice(0, start) + newText + value.slice(end);
    ta.setSelectionRange(start + before.length, start + before.length + sel.length);
  }

  ta.focus();
  ta.dispatchEvent(new Event('input'));
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c])); }

// very small allowlist sanitizer to avoid injecting arbitrary HTML
function sanitizeHTML(input){
  const allowed = new Set(['B','I','U','BR','SPAN','DIV','UL','OL','LI','INPUT']); // minimal
  const tmp = document.createElement('div');
  tmp.innerHTML = input || '';

  (function walk(node){
    if (node.nodeType === 1) {
      if (!allowed.has(node.tagName)) {
        // unwrap disallowed element but keep its children
        const parent = node.parentNode;
        while (node.firstChild) parent.insertBefore(node.firstChild, node);
        parent.removeChild(node);
        return;
      }
      // strip attributes we don't expect
      for (const attr of Array.from(node.attributes)) {
        const t = node.tagName;
        if (t === 'INPUT' && attr.name === 'type' && node.getAttribute('type') === 'checkbox') continue;
        else node.removeAttribute(attr.name);
      }
    }
    for (const child of Array.from(node.childNodes)) walk(child);
  })(tmp);

  return tmp.innerHTML;
}

function updateHtml(id, html){
  const notes = load();
  const n = notes.find(x => x.id === id);
  if (!n) return;
  n.html = sanitizeHTML(html);
  // you can optionally keep a plain-text fallback if you like
  n.text = undefined;
  save(notes);
}
  
/* === CALENDAR VIEW TOGGLE (Agenda / Week / Month) === */
(() => {
  const iframe = document.querySelector('.sidebar .iframe-wrap iframe');
  if (!iframe) return;

  // IDs:
  const CAL_MAIN = 'j27deqargjjbeg5835162djbl8@group.calendar.google.com';
  const CAL_293T = '0192dc1394d85223a6c361fc1a8875ab5db51d465c28fffafb6d7abe9d9e8e0d@group.calendar.google.com';

  // Load saved state (default MONTH + MAIN)
  let mode  = localStorage.getItem('labCalMode') || 'MONTH';
  let which = localStorage.getItem('labCalWhich') || 'MAIN';

  // Build and apply iframe URL
  function apply() {
    const srcId = (which === '293T') ? CAL_293T : CAL_MAIN;
    const params = new URLSearchParams({
      src: srcId,
      ctz: 'America/New_York',
      showPrint: '0',
      showTabs: '0',
      showCalendars: '0',
      showTitle: '0',
      showTz: '0',
      wkst: '1',
      bgcolor: '#ffffff'
    });
    iframe.src = `https://calendar.google.com/calendar/embed?${params.toString()}&mode=${encodeURIComponent(mode)}`;

    // Update pressed states
    document.querySelectorAll('.calendar-toolbar .btn[data-mode]')
      .forEach(b => b.setAttribute('aria-pressed', String((b.dataset.mode||'') === mode)));
    document.querySelectorAll('.calendar-toolbar .btn[data-cal]')
      .forEach(b => b.setAttribute('aria-pressed', String((b.dataset.cal||'') === which)));
  }

  // Wire up listeners
  document.querySelectorAll('.calendar-toolbar .btn[data-mode]').forEach(b => {
    b.addEventListener('click', () => {
      mode = b.dataset.mode || 'MONTH';
      localStorage.setItem('labCalMode', mode);
      apply();
    });
  });

  document.querySelectorAll('.calendar-toolbar .btn[data-cal]').forEach(b => {
    b.addEventListener('click', () => {
      which = b.dataset.cal || 'MAIN';
      localStorage.setItem('labCalWhich', which);
      apply();
    });
  });

  // Initial render
  apply();
})();

/* === QUICK FIND (center grid only) === */
const q = document.getElementById('q');
const linkItems = Array.from(document.querySelectorAll('main.grid .list a'));
const sections  = Array.from(document.querySelectorAll('main.grid section.card'));
function normalize(s){ return s.toLowerCase().replace(/\s+/g,' ').trim(); }
if (q) {
  q.addEventListener('input', () => {
    const term = normalize(q.value);
    if(!term){
      sections.forEach(sec => sec.style.display = '');
      linkItems.forEach(a => a.parentElement.style.display = '');
      return;
    }
    sections.forEach(sec => sec.style.display = 'none');
    linkItems.forEach(a => {
      const text = normalize(a.textContent);
      const match = text.includes(term);
      a.parentElement.style.display = match ? '' : 'none';
      if(match){
        const section = a.closest('section.card');
        if(section) section.style.display = '';
        const details = a.closest('details');
        if(details && !details.open) details.open = true;
      }
    });
  });
}

/* === DATA LOAD (Decap JSON) === */
function portalJsonUrl() {
  // If a <base href="..."> exists, use it (already absolute)
  const baseHref = document.querySelector('base')?.href;
  if (baseHref) return new URL('data/lab-portal.json', baseHref).href;

  // Otherwise build an absolute base from the current page
  const base = location.origin + location.pathname.replace(/\/[^/]*$/, '/');
  return new URL('data/lab-portal.json', base).href;
}

const APPS_URL = 'https://script.google.com/macros/s/AKfycbwuVJMzPdif9iYUHNio1jKIEr6t9a9d1f9Vl-rA50-pDhe40NpJL9I4smVdKr1g2skm/exec';

function normalizeLevel(l){
  if(!l) return 'info';
  l = String(l).toLowerCase();
  if (l.startsWith('warn')) return 'warn';
  if (l.startsWith('urg'))  return 'urgent';
  return 'info';
}
function ensureIds(arr){
  return (arr||[]).map(a => {
    const out = Object.assign({}, a);
    // if id missing or empty, create a stable id from text+when
    if (!out.id || String(out.id).trim() === '') {
      try { out.id = btoa(unescape(encodeURIComponent(`${out.when||''}::${out.text||''}`))).slice(0,24); }
      catch(e){ out.id = (Math.random().toString(36).slice(2,10)); }
    }
    out.level = normalizeLevel(out.level);
    return out;
  });
}

  ANN_APPS_URL = 'https://script.google.com/macros/s/AKfycbwuVJMzPdif9iYUHNio1jKIEr6t9a9d1f9Vl-rA50-pDhe40NpJL9I4smVdKr1g2skm/exec';

async function fetchPortalData() {
  const appsUrl = ANN_APPS_URL + '?t=' + Date.now();
  const jsonUrl = portalJsonUrl() + '?v=' + Date.now();

  let announcements = [];
  let rotations = null;
  let rotationPlan = null;

  // 1) Fetch announcements from Apps Script
  try {
    const resp = await fetch(appsUrl, { cache: 'no-store' });
    if (resp.ok) {
      const body = await resp.json();
      announcements = ensureIds(body.announcements || []);
    }
  } catch(e) {
    console.warn('Apps Script fetch failed:', e);
  }

  // 2) Fetch rotations & rotationPlan from GitHub JSON
  try {
    const resp = await fetch(jsonUrl, { cache: 'no-store' });
    if (resp.ok) {
      const body = await resp.json();
      rotations = body.rotations || null;
      rotationPlan = body.rotationPlan || null;
    }
  } catch(e) {
    console.warn('GitHub JSON fetch failed:', e);
  }

  return { announcements, rotations, rotationPlan };
}

/* Renderers */
/* === Per-announcement read tracking === */
const ANN_READ_KEY = 'lab_announcements_read_ids_v1';

function getReadSet(){
  try { return new Set(JSON.parse(localStorage.getItem(ANN_READ_KEY) || '[]')); }
  catch { return new Set(); }
}
function saveReadSet(set){
  localStorage.setItem(ANN_READ_KEY, JSON.stringify([...set]));
}
function markAnnouncementRead(id){
  const set = getReadSet();
  set.add(id);
  saveReadSet(set);
}

function parseDateSafe(s){
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function fmtDayShort(d){
  return d.toLocaleDateString(undefined,{ month:'short', day:'numeric' });
}
function levelToClass(level){
  const v = String(level||'info').toLowerCase();
  if (v.startsWith('warn')) return 'warn';
  if (v.startsWith('urg'))  return 'urgent';
  return 'info';
}
function hashId(text, when){ // stable-ish client id
  return btoa(unescape(encodeURIComponent(`${when}::${text}`))).slice(0,24);
}

const ANN_SEEN_KEY = 'lab_announcements_last_seen_v1';

function getLastSeenTs(){
  const v = localStorage.getItem(ANN_SEEN_KEY);
  const n = v ? Number(v) : 0;
  return Number.isFinite(n) ? n : 0;
}
function setLastSeenTs(ts){
  localStorage.setItem(ANN_SEEN_KEY, String(ts));
}

function autoLink(s){
  // very small autolinker for http(s)://â€¦ â€” keeps things safe by using textContent elsewhere
  return s.replace(/\bhttps?:\/\/[^\s)]+/g, (m)=>`<a class="link ext" href="${m}" target="_blank" rel="noopener">${m}</a>`);
}

function showAnnToast(count){
  const toast = document.getElementById('notice');
  const text  = document.getElementById('notice-text');
  const dot   = document.getElementById('ann-header-dot');

  // Always reset state first
  if (dot) dot.classList.remove('show');

  // If there are new ones, show toast + dot
  if (count > 0) {
    if (toast && text) {
      toast.classList.add('ann-toast');
      text.innerHTML = `<strong>${count}</strong> new announcement${count>1?'s':''}`;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 5500);
    }
    if (dot) dot.classList.add('show');
  } else {
    // no unread â†’ hide toast + dot
    if (toast) toast.classList.remove('show');
    if (dot) dot.classList.remove('show');
  }
}

function updateAnnDotVisibility(){
  const dot = document.getElementById('ann-header-dot');
  if (!dot) return;
  const unread = document.querySelectorAll('#ann-banner-list .ann-item:not(.read)').length;
  dot.classList.toggle('show', unread > 0);
}

function renderAnnouncements(items){
  const list = document.getElementById('ann-banner-list');
  if (!list) return;

  const lastSeen = getLastSeenTs();
  let newestTs = lastSeen;
  let newCount = 0;

  const readSet = getReadSet();

  const sorted = (items||[]).slice().sort((a,b) => {
    const da = parseDateSafe(a.when) || new Date(0);
    const db = parseDateSafe(b.when) || new Date(0);
    return db - da;
  });

  const frag = document.createDocumentFragment();

  sorted.forEach(({ text, when, level, link }) => {
    const d  = parseDateSafe(when) || new Date(0);
    const ts = d.getTime();
    if (ts > newestTs) newestTs = ts;

    const id = hashId(text||'', when||'');
    const isRead = readSet.has(id);
    const isNew  = !isRead && ts > lastSeen;
    if (isNew) newCount++;

    const li = document.createElement('li');
    const lvl = levelToClass(level);               // "info" | "warn" | "urgent"
    li.className = `ann-item ${lvl}${isNew ? ' new' : ''}`;
    li.dataset.id = id;

    // Header
    const head = document.createElement('div');
    head.className = 'ann-head';

    const time = document.createElement('div');
    time.className = 'ann-time';
    time.textContent = d ? fmtDayShort(d) : '';

    const badgeNew = document.createElement('span');
    badgeNew.className = 'badge-new';
    badgeNew.textContent = 'NEW';
    head.append(time, badgeNew);

    // Body
    const body = document.createElement('div');
    body.className = 'ann-body';
    const safe = document.createElement('div');
    safe.innerHTML = autoLink((text || '').replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c])));
    body.appendChild(safe);

    // Actions
    const actions = document.createElement('div');
    actions.className = 'ann-actions';
    if (link) {
      const a = document.createElement('a');
      a.className = 'btn-min link ext';
      a.href = link; a.target = '_blank'; a.rel = 'noopener';
      a.innerHTML = `<span class="ms" aria-hidden="true">open_in_new</span> Open`;
      actions.appendChild(a);
    }

    // Mark-as-read
    const mark = document.createElement('button');
    mark.type = 'button';
    mark.className = 'btn-min';
    mark.innerHTML = `<span class="ms" aria-hidden="true">done</span> Mark read`;
    mark.addEventListener('click', () => {
      markAnnouncementRead(id);
      li.classList.remove('new');
      li.classList.add('read');   // fade/hide button via CSS
      mark.classList.add('marked');
      updateAnnDotVisibility();   // <- live toggle of red dot
    });
    actions.appendChild(mark);

    // If previously read, reflect that on load
    if (isRead) {
      mark.classList.add('marked');
      li.classList.add('read');
    }

    // Append (no chip anymore)
    li.append(head, body, actions);
    frag.appendChild(li);
  });

  list.innerHTML = '';
  list.appendChild(frag);

  // Enable per-item clamp + "More/Less" only when needed
  requestAnimationFrame(() => {
    document.querySelectorAll('#ann-banner-list .ann-item').forEach(li => {
      const body = li.querySelector('.ann-body');
      const actions = li.querySelector('.ann-actions');
      if (!body || !actions) return;
  
      // start clamped
      body.classList.add('clamp');
  
      // create the toggle button
      const moreBtn = document.createElement('button');
      moreBtn.type = 'button';
      moreBtn.className = 'ann-more';
      moreBtn.textContent = 'More';
      moreBtn.addEventListener('click', () => {
        const expanded = li.classList.toggle('expanded');
        if (expanded) {
          body.classList.remove('clamp');
          moreBtn.textContent = 'Less';
        } else {
          body.classList.add('clamp');
          moreBtn.textContent = 'More';
        }
      });
  
      // insert the button at the start of the actions row
      actions.prepend(moreBtn);
  
      // if it doesn't actually overflow at 4 lines, hide the button + unclamp
      // (allow a tiny tolerance for rounding)
      if (body.scrollHeight <= body.clientHeight + 1) {
        body.classList.remove('clamp');
        moreBtn.style.display = 'none';
      }
    });
  });

  showAnnToast(newCount);
  updateAnnDotVisibility();       // ensure header dot reflects current unread state

  // Optional: "Mark all read" control, if present
  const markAll = document.getElementById('ann-mark-read');
  if (markAll){
    markAll.onclick = () => {
      // add all ids to read set
      const ids = Array.from(list.querySelectorAll('.ann-item')).map(li => li.dataset.id);
      const set = getReadSet();
      ids.forEach(id => set.add(id));
      saveReadSet(set);

      // update UI
      list.querySelectorAll('.ann-item').forEach(el => {
        el.classList.remove('new');
        el.classList.add('read');
        const btn = el.querySelector('.btn-min');
        if (btn) btn.classList.add('marked');
      });

      setLastSeenTs(Math.max(newestTs, Date.now()));
      updateAnnDotVisibility();
    };
  }
}

function renderRotations(obj){
  const elDates = document.getElementById('rot-dates');
  const elGrid  = document.getElementById('rot-grid');
  if(!elDates || !elGrid) return;

  const badgeDate = (s) => {
    const d = new Date(s);
    return isNaN(d) ? '' : d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
  };
  const esc = (s)=>String(s??'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

  elDates.innerHTML = `<span class="ms" aria-hidden="true">calendar_month</span> ${badgeDateYMD(obj.start)} â€“ ${badgeDateYMD(obj.end)}`;
  elGrid.innerHTML = `
    <div class="rot-col"><div class="rot-h rot-tc1">TC1</div><div class="rot-body">${esc(obj.tc1||'â€”')}</div></div>
    <div class="rot-col"><div class="rot-h rot-tc2">TC2</div><div class="rot-body">${esc(obj.tc2||'â€”')}</div></div>
    <div class="rot-col"><div class="rot-h rot-tc3">TC3</div><div class="rot-body">${esc(obj.tc3||'â€”')}</div></div>
    <div class="rot-col"><div class="rot-h rot-main">Main Lab</div><div class="rot-body">${esc(obj.main||'â€”')}</div></div>
  `;
}

function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function addDays(d,n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function diffDays(a,b){ return Math.round((a - b) / 86400000); }

// Function rotates the plan every periodDays; indefinitely loops through lists
function computeRotationFromPlan(plan) {
  const start = parseYMDLocal(plan?.start);
  const period = Number(plan?.periodDays) || 14;
  if (!start || period <= 0) return null;

  const today = getTodayLocal(); // <â€” use the override-aware "today"
  const MS = 24 * 60 * 60 * 1000;

  const daysSinceStart = Math.floor((today - start) / MS);
  const cycleIndex = Math.max(0, Math.floor(daysSinceStart / period));

  const periodStart = new Date(start.getFullYear(), start.getMonth(), start.getDate() + cycleIndex * period);
  const periodEnd   = new Date(periodStart.getFullYear(), periodStart.getMonth(), periodStart.getDate() + period - 1);

  const pick = (arr) => {
    if (!Array.isArray(arr) || arr.length === 0) return 'â€”';
    return arr[cycleIndex % arr.length] ?? 'â€”';
  };

  const slots = plan.slots || {};
  return {
    start: toInputDateString(periodStart),
    end:   toInputDateString(periodEnd),
    tc1:   pick(slots.tc1),
    tc2:   pick(slots.tc2),
    tc3:   pick(slots.tc3),
    main:  pick(slots.main),
  };
}
  
/* Boot + refresh on tab focus */
(async function initPortal(){
  const data = await fetchPortalData();
  renderAnnouncements(data.announcements || []);

  if (!getLastSeenTs()) setLastSeenTs(Date.now());
  
  let rot = data.rotations || {};
  if (data.rotationPlan) {
    const computed = computeRotationFromPlan(data.rotationPlan);
    if (computed) rot = computed;   // computed period + looped assignees
  }
  renderRotations(rot);
  if (typeof syncCalendarHeight === 'function') setTimeout(syncCalendarHeight, 50);
})();
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState !== 'visible') return;
  const data = await fetchPortalData();
  renderAnnouncements(data.announcements || []);

  if (!getLastSeenTs()) setLastSeenTs(Date.now());
  
  let rot = data.rotations || {};
  if (data.rotationPlan) {
    const computed = computeRotationFromPlan(data.rotationPlan);
    if (computed) rot = computed;   // computed period + looped assignees
  }
  renderRotations(rot);
  if (typeof syncCalendarHeight === 'function') setTimeout(syncCalendarHeight, 50);
});

/* --- Center notes dock in the right gutter --- */
function positionNotesDock(){
  const dock = document.getElementById('notes-dock');
  if (!dock) return;

  const docStyle = getComputedStyle(document.documentElement);
  const pageMaxStr = docStyle.getPropertyValue('--page-max').trim(); // e.g. "1600px"
  const pageMax = parseFloat(pageMaxStr) || 1600;
  const vw = window.innerWidth;

  // gutter = (viewport - contentWidth)/2 (only when viewport wider than content)
  const gutter = Math.max((vw - Math.min(vw, pageMax)) / 2, 0);

  // center the 260px dock inside that gutter; clamp to a minimum 14px from the edge
  const dockHalf = 260 / 2;
  const desiredRight = gutter > 0 ? Math.max(gutter / 2 - dockHalf, 14) : 14;

  dock.style.right = `${Math.round(desiredRight)}px`;
}

window.addEventListener('resize', positionNotesDock);

// /* ==== Sticky Notes (localStorage) ==== */
// const MAX_NOTES = 6;
  
// (function stickyNotes(){
//   const STORAGE_KEY = 'rileyNotes_v1';
//   const MAX_NOTES = 6; // <â€” hard cap
//   const dock = document.getElementById('notes-dock');
//   const triggers = document.querySelectorAll('.add-note-trigger'); // header button(s)

//   const load = () => {
//     try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
//     catch { return []; }
//   };
//   const save = (notes) => localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
//   const makeId = () => Math.random().toString(36).slice(2, 9);

//   function updateAddButtons(notes){
//     const atMax = notes.length >= MAX_NOTES;
//     triggers.forEach(btn => {
//       btn.disabled = atMax;
//       btn.setAttribute('aria-disabled', String(atMax));
//       btn.title = atMax ? `Max ${MAX_NOTES} notes reached` : 'Add sticky note';
//     });
//   }

//   function sortNotes(a, b) {
//     // pinned first, then newest first
//     return (b.pinned - a.pinned) || (b.createdAt - a.createdAt);
//   }
  
//   function render(){
//     const notes = load().slice().sort(sortNotes);
//     dock.innerHTML = '';
//     notes.forEach(n => dock.appendChild(noteEl(n)));
//     positionNotesDock();
//   }

//   function noteEl(note){
//     const el = document.createElement('div');
//     el.className = 'note-card';
//     el.dataset.id = note.id;
  
//     const toolbar = document.createElement('div');
//     toolbar.className = 'note-toolbar';
  
//     // editor (rich text)
//     const editor = document.createElement('div');
//     editor.className = 'note-editor';
//     editor.contentEditable = 'true';
//     editor.innerHTML = note.html ? note.html : escapeHtml(note.text || '');
//     editor.addEventListener('input', debounce(() => updateHtml(note.id, editor.innerHTML), 200));
  
//     // formatting buttons
//     const bBold = makeBtn('B', 'Bold', () => cmd('bold'));
//     const bItalic = makeBtn('I', 'Italic', () => cmd('italic'));
//     const bUnderline = makeBtn('U', 'Underline', () => cmd('underline'));
//     const bBullet = makeBtn('â€¢', 'Bulleted list', () => cmd('insertUnorderedList'));
//     const bChecklist = makeBtn('â˜‘', 'Insert checklist item', () => insertChecklistItem(editor));
  
//     // pin / delete
//     const bPin = makeBtn(note.pinned ? 'Unpin' : 'Pin', 'Pin note', () => togglePin(note.id));
//     const bDel = makeBtn('Delete', 'Delete note', () => deleteNote(note.id));
  
//     toolbar.append(bBold, bItalic, bUnderline, bBullet, bChecklist, bPin, bDel);
//     el.append(toolbar, editor);
//     return el;
  
//     function makeBtn(label, title, fn){
//       const btn = document.createElement('button');
//       btn.className = 'note-btn';
//       btn.type = 'button';
//       btn.title = title;
//       btn.textContent = label;
//       btn.addEventListener('click', () => {
//         // keep focus in this note while formatting
//         editor.focus();
//         fn();
//         // persist after a command
//         updateHtml(note.id, editor.innerHTML);
//       });
//       return btn;
//     }
  
//     function cmd(name){
//       // execCommand is deprecated but still works great for simple styling in all major browsers
//       document.execCommand(name, false, null);
//     }
//   }
  
//   function makeFmtBtn(label, title, fn){
//     const b = document.createElement('button');
//     b.className = 'note-btn';
//     b.type = 'button';
//     b.textContent = label;
//     b.title = title;
//     b.addEventListener('click', fn);
//     return b;
//   }

//   function pulseButtons(){
//     triggers.forEach(btn => {
//       btn.classList.add('shake');
//       setTimeout(() => btn.classList.remove('shake'), 300);
//     });
//   }

//   function addNote(){
//     const notes = load();
//     if (notes.length >= MAX_NOTES) {
//       alert(`You can keep up to ${MAX_NOTES} notes. Delete one to add another.`);
//       return;
//     }
//     notes.unshift({ id: makeId(), text: '', pinned: true, createdAt: Date.now() });
//     save(notes);
//     render();
//     const first = dock.querySelector('.note-card .note-textarea');
//     if (first) first.focus();
//   }

//   function deleteNote(id){
//     const notes = load().filter(n => n.id !== id);
//     save(notes);
//     render(); // re-enables Add when dropping below cap
//   }

//   function togglePin(id){
//     const notes = load();
//     const n = notes.find(x => x.id === id);
//     if (!n) return;
//     n.pinned = !n.pinned;
//     notes.sort(sortNotes);
//     save(notes);
//     render();
//   }

//   function updateText(id, text){
//     const notes = load();
//     const n = notes.find(x => x.id === id);
//     if (!n) return;
//     n.text = text;
//     save(notes);
//   }

//   function debounce(fn, ms){
//     let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
//   }

//   function insertChecklistItem(editor){
//     // Ensure there is/starts a checklist UL and add an empty item
//     const sel = window.getSelection();
//     if (!sel || sel.rangeCount === 0) { editor.focus(); return; }
//     const range = sel.getRangeAt(0);
  
//     // find nearest UL.checklist
//     let ul = editor.closest('ul.checklist') || findAncestor(range.commonAncestorContainer, n => n.tagName === 'UL' && n.classList.contains('checklist'));
//     if (!ul) {
//       ul = document.createElement('ul');
//       ul.className = 'checklist';
//       range.surroundContents(document.createTextNode(''));
//       range.insertNode(ul);
//     }
  
//     const li = document.createElement('li');
//     const box = document.createElement('input');
//     box.type = 'checkbox';
//     li.appendChild(box);
//     li.appendChild(document.createTextNode(' '));
//     ul.appendChild(li);
  
//     // place caret at end of new li
//     const r = document.createRange();
//     r.selectNodeContents(li);
//     r.collapse(false);
//     sel.removeAllRanges();
//     sel.addRange(r);
//   }
  
//   function findAncestor(node, pred){
//     while (node && node.nodeType === 1 || node && node.parentNode){
//       if (node.nodeType === 1 && pred(node)) return node;
//       node = node.parentNode;
//     }
//     return null;
//   }

//   // Wire up all â€œadd noteâ€ triggers (your header button has .add-note-trigger)
//   triggers.forEach(btn => btn.addEventListener('click', addNote));

//   render();
// })();

/* === Calendar height sync === */
function syncCalendarHeight(){

  // On small screens, let the fixed iframe height take over
  if (window.innerWidth <= 768) return;
  
  const calCard   = document.getElementById('live-cal-card');
  const topCard   = document.getElementById('card-calendars-hood');
  const bottomCard= document.getElementById('card-upenn-cores');
  if(!calCard || !topCard || !bottomCard) return;

  const grid   = topCard.closest('.grid');
  const rowGap = grid ? parseFloat(getComputedStyle(grid).rowGap || '0') : 0;
  const target = topCard.offsetHeight + rowGap + bottomCard.offsetHeight;

  calCard.style.height = target + 'px';

  const head    = calCard.querySelector('h2');
  const toolbar = calCard.querySelector('.calendar-toolbar');
  const padding = 18 * 2;
  const extra   = (head?.offsetHeight || 0) + (toolbar?.offsetHeight || 0) + padding;

  const wrap = calCard.querySelector('.iframe-wrap');
  if (wrap) {
    wrap.style.height = Math.max(200, target - extra) + 'px';
    const iframe = wrap.querySelector('iframe');
    if (iframe) iframe.style.height = '100%';
  }
}
window.addEventListener('load',  syncCalendarHeight);
window.addEventListener('resize', () => {
  clearTimeout(syncCalendarHeight._t);
  syncCalendarHeight._t = setTimeout(syncCalendarHeight, 120);
});
document.addEventListener('toggle', (e) => {
  if (e.target.tagName === 'DETAILS') setTimeout(syncCalendarHeight, 120);
}, true);
  
</script>


</body>
</html>


















